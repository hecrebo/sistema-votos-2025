<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Votos 2025</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="favicon.ico/apple-icon-180x180.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.ico/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon.ico/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.ico/apple-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon.ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon.ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon.ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon.ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon.ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon.ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon.ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="favicon.ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" href="favicon.ico/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="favicon.ico/apple-icon-precomposed.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="144x144" href="favicon.ico/android-icon-144x144.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon.ico/android-icon-96x96.png">
    <link rel="icon" type="image/png" sizes="72x72" href="favicon.ico/android-icon-72x72.png">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon.ico/android-icon-48x48.png">
    <link rel="icon" type="image/png" sizes="36x36" href="favicon.ico/android-icon-36x36.png">
    
    <!-- Microsoft Icons -->
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="favicon.ico/ms-icon-144x144.png">
    <meta name="msapplication-config" content="favicon.ico/browserconfig.xml">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Ocultar botones espec√≠ficos de roles por defecto para evitar flash */
        #nav-verifier-dashboard,
        #nav-verifier-history,
        #nav-registrator-dashboard,
        #nav-registrator-history {
            display: none !important;
        }
        
        /* Ocultar todos los botones de navegaci√≥n hasta que se configuren */
        .nav-btn {
            display: none !important;
        }
        
        /* Mostrar botones solo cuando se configuren correctamente */
        .nav-btn.configured {
            display: inline-block !important;
        }
    </style>
    <!-- FUNCIONES DEL REGISTRO MASIVO - CARGAR PRIMERO -->
    <script src="registro-masivo-functions.js"></script>
    
    <!-- PDF Libraries (cargar antes que otros scripts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    
    <script src="config.js"></script>
    <script src="script-firebase.js"></script>
    <script src="auto-init.js"></script>
    <script src="test-automatico.js"></script>
    <script src="test-proyeccion.js"></script>
    <script src="queue-manager.js"></script>
    <script src="notification-system.js"></script>
    <script src="realtime-notifications.js"></script>
    <script src="pwa-installer.js"></script>
    <script src="pwa-debug.js"></script>
    <!-- Chart.js para gr√°ficos del verificador -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Funciones espec√≠ficas para verificadores -->
    <script src="verifier-functions.js"></script>
    <!-- Funciones espec√≠ficas para registradores -->
    <script src="registrator-functions.js"></script>
    
    <!-- Agregar Choices.js para autocomplete -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="choices.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo-container">
                        <img src="logo 2.png" alt="Logo Sistema de Votos" class="header-logo">
                    </div>
                    <h1 class="header-title">Registro de Votos y Estad√≠sticas</h1>
                </div>
                <nav class="nav-menu">
                    <button class="nav-btn active" data-page="registration" id="nav-registration">Registro</button>
                    <button class="nav-btn" data-page="check-in" id="nav-check-in">Confirmar Voto</button>
                    <button class="nav-btn" data-page="verifier-dashboard" id="nav-verifier-dashboard">üìä Mi Dashboard (Verificador)</button>
                    <button class="nav-btn" data-page="verifier-history" id="nav-verifier-history">üìã Mi Historial (Verificador)</button>
                    <button class="nav-btn" data-page="registrator-dashboard" id="nav-registrator-dashboard">üìä Mi Dashboard (Registrador)</button>
                    <button class="nav-btn" data-page="registrator-history" id="nav-registrator-history">üìã Mi Historial (Registrador)</button>
                    <button class="nav-btn" data-page="listado" id="nav-listado">Listado</button>
                    <button class="nav-btn" data-page="dashboard" id="nav-dashboard">Totales</button>
                    <button class="nav-btn" data-page="statistics" id="nav-statistics">Estad√≠sticas</button>
                    <button class="nav-btn" onclick="window.location.href='estadisticas-avanzadas.html'" id="nav-advanced-stats">üìä Estad√≠sticas Avanzadas</button>
                </nav>
                <div class="user-info">
                    <span class="user-id" id="userId"></span>
                    <button class="btn btn-primary" onclick="installPWA()" id="manual-install-btn" style="display: none; margin-right: 10px;">
                        üì± Instalar App
                    </button>
                    <button class="btn btn-outline" onclick="votingSystem.logout()" style="margin-right: 10px; border: 1px solid #e5e7eb; color: #ffffff; background: transparent;">
                        Cerrar Sesi√≥n
                    </button>

                    <div class="sync-status">
                        <span class="sync-spinner" id="sync-spinner"></span>
                        <span class="sync-check" id="sync-check"></span>
                        <span class="sync-indicator" id="sync-indicator">üîÑ</span>
                        <span class="sync-text" id="sync-text">Sincronizando</span>
                    </div>
                    <!-- Indicador de estado offline -->
                    <div class="offline-indicator" id="offline-indicator">
                        <span class="offline-icon">üì¥</span>
                        <span class="offline-text">Sin conexi√≥n</span>
                    </div>

                    <!-- Eliminar panel y botones de migraci√≥n -->
                </div>
                <!-- Men√∫ desplegable m√≥vil -->
                <div class="mobile-menu">
                    <button class="menu-toggle" onclick="toggleMenu()">‚ãÆ</button>
                    <div class="menu-dropdown" id="menu-dropdown">
                        <!-- El contenido del men√∫ se generar√° din√°micamente por JS seg√∫n el rol -->
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Registration Page -->
            <div class="page active" id="registration-page">
                <div class="page-container">
                    <h2 class="page-title">Registro de Persona</h2>
                    
                    <!-- Selector de modo de registro -->
                    <div class="registration-mode-selector">
                        <button type="button" class="mode-btn active" data-mode="individual" onclick="switchRegistrationMode('individual')">
                            üë§ Registro Individual
                        </button>
                        <button type="button" class="mode-btn" data-mode="bulk" onclick="switchRegistrationMode('bulk')">
                            üìä Registro Masivo (Excel)
                        </button>
                    </div>
                    
                    <!-- Formulario de registro √∫nico con listas independientes -->
                    <div id="individual-registration" class="registration-mode">
                        <form id="registration-form" class="registration-form" autocomplete="off">
                            <div class="form-group">
                                <label for="community">Comunidad</label>
                                <select id="community" name="community" required></select>
                            </div>
                            <div class="form-group">
                                <label for="name">Nombre de la Persona</label>
                                <input type="text" id="name" name="name" placeholder="Ej: Juan P√©rez" required autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="cedula">C√©dula</label>
                                <input type="text" id="cedula" name="cedula" placeholder="Ej: 12345678" required title="Introduce una c√©dula v√°lida (solo n√∫meros, 6 a 10 d√≠gitos)" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="telefono">Tel√©fono (opcional)</label>
                                <input type="text" id="telefono" name="telefono" placeholder="Ej: 04121234567" title="Introduce un tel√©fono v√°lido (ej: 04121234567)" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="sexo">Sexo</label>
                                <select id="sexo" name="sexo" required>
                                    <option value="">Selecciona el sexo</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edad">Edad</label>
                                <input type="number" id="edad" name="edad" placeholder="Ej: 25" min="16" max="120" required title="Introduce una edad v√°lida (entre 16 y 120 a√±os)" autocomplete="off">
                            </div>
                                                <div class="form-group">
                        <label for="ubch">Centro de Votaci√≥n</label>
                        <select id="ubch" name="ubch" required></select>
                    </div>
                            <button type="submit" class="btn btn-primary btn-large" id="register-btn">
                                <span class="btn-text">Registrar Persona</span>
                                <span class="btn-loading" style="display: none;">Registrando...</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Registro masivo desde Excel -->
                    <div id="bulk-registration" class="registration-mode" style="display: none;">
                        <div class="admin-card import-section" style="padding: 2rem; margin: 1rem 0;">
                            <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-size: 1.5rem;">üìä Registro Masivo</h3>
                            
                            <!-- Informaci√≥n mejorada -->
                            <div class="import-info" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #007bff;">
                                <p style="margin-bottom: 1rem; color: #495057; line-height: 1.6;">Pega los datos de Excel en la tabla o carga un archivo. Los registros v√°lidos se enviar√°n autom√°ticamente y se borrar√°n de la tabla.</p>
                                <p style="margin: 0; color: #6c757d; font-size: 0.95rem;"><strong>Columnas:</strong> <b>Centro de Votaci√≥n, Comunidad, Nombre, C√©dula, Tel√©fono (opcional), Sexo, Edad</b></p>
                            </div>

                            <!-- Controles principales ARRIBA de la tabla -->
                            <div class="import-controls-main" style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem;">
                                <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                                <button class="btn btn-info" onclick="document.getElementById('excel-file-input').click()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    üìÅ Cargar Excel
                                </button>
                                <button class="btn btn-success" onclick="procesarRegistrosMasivos()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    üì§ Procesar Registros
                                </button>
                                <button class="btn btn-warning" onclick="limpiarTablaMasiva()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    üóëÔ∏è Limpiar Todo
                                </button>
                                <button class="btn btn-secondary" onclick="downloadTemplate()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    üìã Plantilla
                                </button>
                                <button class="btn btn-outline-secondary" onclick="actualizarConfiguracionMasivo()" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                                    ‚öôÔ∏è Configurar
                                </button>
                                <button class="btn btn-outline-danger" onclick="forzarReinicializacionRegistroMasivo()" style="padding: 0.75rem 1.5rem; font-size: 1rem;" title="Reinicializar si hay problemas">
                                    üîÑ Reinicializar
                                </button>
                            </div>

                            <!-- Contadores en tiempo real -->
                            <div class="bulk-stats" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <div class="stat-item" style="background: #e8f5e8; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #28a745;">
                                    <span style="font-weight: bold; color: #28a745;">‚úÖ V√°lidos:</span>
                                    <span id="valid-count" style="margin-left: 0.5rem;">0</span>
                                </div>
                                <div class="stat-item" style="background: #fff3cd; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #ffc107;">
                                    <span style="font-weight: bold; color: #856404;">‚ö†Ô∏è Errores:</span>
                                    <span id="error-count" style="margin-left: 0.5rem;">0</span>
                                </div>
                                <div class="stat-item" style="background: #ffeaa7; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #f39c12;">
                                    <span style="font-weight: bold; color: #856404;">üîÑ Duplicados:</span>
                                    <span id="duplicate-count" style="margin-left: 0.5rem;">0</span>
                                </div>
                                <div class="stat-item" style="background: #e3f2fd; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #2196f3;">
                                    <span style="font-weight: bold; color: #1976d2;">üìä Total:</span>
                                    <span id="total-count" style="margin-left: 0.5rem;">0</span>
                                </div>
                            </div>

                            <!-- Barra de progreso -->
                            <div id="progress-container" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span id="progress-text">Procesando...</span>
                                    <span id="progress-percentage">0%</span>
                                </div>
                                <div style="background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div id="progress-bar" style="background: #007bff; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>

                            <!-- Tabla simplificada -->
                            <div style="overflow-x:auto; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <table id="paste-table" class="preview-table" contenteditable="true" spellcheck="false" style="min-width:800px; margin: 0;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Centro de Votaci√≥n</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Comunidad</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Nombre</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">C√©dula</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Tel√©fono</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Sexo</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Edad</th>
                                            <th style="padding: 1rem 0.75rem; background: #e9ecef; font-weight: 600; color: #495057;">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paste-table-body">
                                        <tr style="background: #fff;">
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 120px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 120px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 80px;"></td>
                                            <td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 80px;"></td>
                                            <td style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 100px; text-align: center; color: #6c757d;">Pendiente</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Estado del import -->
                            <div id="import-massive-status" class="import-status info" style="display:none; margin-top: 1rem;"></div>
                        </div>
                    </div>
                    


                    <div id="registration-message" class="message" style="display: none;"></div>
                    <div id="queue-status" class="queue-status" style="display: none;"></div>
                    <div id="thank-you-message" class="thank-you-message" style="display: none;"></div>
                </div>
            </div>

            <!-- Check-in Page -->
            <div class="page" id="check-in-page">
                <div class="page-container">
                    <h2 class="page-title">Confirmar Voto</h2>
                    <form id="check-in-form" class="check-in-form">
                        <div class="search-container">
                            <input type="text" id="cedula-search" placeholder="Buscar por C√©dula" required>
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text">Buscar</span>
                                <span class="btn-loading" style="display: none;">Buscando...</span>
                            </button>
                        </div>
                    </form>
                    <div id="check-in-message" class="message" style="display: none;"></div>
                    <div id="search-results" class="search-results"></div>
                </div>
            </div>

            <!-- List Page -->
            <div class="page" id="listado-page">
                <div class="page-container">
                    <div class="page-header">
                        <h2 class="page-title">Listado de Personas Registradas</h2>
                        <div class="page-actions">
                            <button id="export-pdf-btn" class="btn btn-secondary">Generar PDF</button>
                            <button id="export-csv-btn" class="btn btn-secondary" title="Exporta registros seleccionados o todos los filtrados">üìä Generar CSV</button>
                        </div>
                    </div>
                    <div class="filter-container">
                        <!-- Primera fila: B√∫squeda y contadores -->
                        <div class="filter-row-1">
                            <div class="search-bar-container">
                                <div class="search-input-group">
                                    <input type="text" id="list-search" placeholder="Buscar por nombre, c√©dula, comunidad..." class="search-input">
                                    <button type="button" id="clear-search" class="clear-search-btn" style="display: none;">‚úï</button>
                                </div>
                                <div class="search-options">
                                    <select id="search-field" class="search-field-select">
                                        <option value="all">Todos los campos</option>
                                        <option value="name">Nombre</option>
                                        <option value="cedula">C√©dula</option>
                                        <option value="community">Comunidad</option>
                                        <option value="ubch">Centro de Votaci√≥n</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="general-counters">
                                <div class="counter-item">
                                    <span class="counter-label">Total:</span>
                                    <span class="counter-value" id="total-counter">0</span>
                                </div>
                                <div class="counter-item">
                                    <span class="counter-label">Votaron:</span>
                                    <span class="counter-value voted" id="voted-counter">0</span>
                                </div>
                                <div class="counter-item">
                                    <span class="counter-label">No Votaron:</span>
                                    <span class="counter-value not-voted" id="not-voted-counter">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Segunda fila: Filtros principales y avanzados -->
                        <div class="filter-row-2">
                        <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">
                                    <span class="filter-text">Todos</span>
                                    <span class="filter-count" id="all-count">0</span>
                                </button>
                                <button class="filter-btn" data-filter="voted">
                                    <span class="filter-text">Votaron</span>
                                    <span class="filter-count" id="voted-count">0</span>
                                </button>
                                <button class="filter-btn" data-filter="not-voted">
                                    <span class="filter-text">No Votaron</span>
                                    <span class="filter-count" id="not-voted-count">0</span>
                                </button>
                        </div>
                            
                            <div class="advanced-filters">
                        <div class="ubch-filter">
                                    <label for="ubch-filter-select">Centro de Votaci√≥n:</label>
                            <select id="ubch-filter-select" class="ubch-filter-select">
                                <option value="">Todos los Centros de Votaci√≥n</option>
                            </select>
                        </div>
                        <div class="community-filter">
                                    <label for="community-filter-select">Comunidad:</label>
                            <select id="community-filter-select" class="community-filter-select">
                                <option value="">Todas las Comunidades</option>
                            </select>
                        </div>
                                <div class="age-filter">
                                    <label for="age-filter-select">Edad:</label>
                                    <select id="age-filter-select" class="age-filter-select">
                                        <option value="">Todas las edades</option>
                                        <option value="16-25">16-25 a√±os</option>
                                        <option value="26-35">26-35 a√±os</option>
                                        <option value="36-45">36-45 a√±os</option>
                                        <option value="46-55">46-55 a√±os</option>
                                        <option value="56+">56+ a√±os</option>
                                    </select>
                    </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de filtros aplicados -->
                        <div class="filter-info" id="filter-info" style="display: none;">
                            <span class="filter-info-text">Filtros aplicados</span>
                        </div>
                    </div>
                    <!-- Acciones masivas -->
                    <div id="bulk-actions" class="bulk-actions">
                        <div class="bulk-select-all">
                            <input type="checkbox" id="select-all-checkbox" class="row-checkbox">
                            <label for="select-all-checkbox">Seleccionar todos</label>
                        </div>
                        <div class="bulk-actions-buttons">
                            <button class="btn btn-success btn-small" onclick="votingSystem.bulkConfirmVotes()">üéØ Confirmar Votos</button>
                            <button class="btn btn-danger btn-small" id="bulk-delete-btn" onclick="votingSystem.bulkDeleteVotes()">‚ùå Eliminar</button>
                        </div>
                    </div>

                    <!-- Vista detallada -->
                    <div id="detail-view" class="detail-view">
                        <div class="detail-header">
                            <h3 class="detail-title">Detalles del Registro</h3>
                            <button class="detail-close" onclick="votingSystem.closeDetailView()">‚úï</button>
                        </div>
                        <div class="detail-content">
                            <div class="detail-section">
                                <h4>Informaci√≥n Personal</h4>
                                <div class="detail-info"><strong>Nombre:</strong> <span id="detail-name"></span></div>
                                <div class="detail-info"><strong>C√©dula:</strong> <span id="detail-cedula"></span></div>
                                <div class="detail-info"><strong>Tel√©fono:</strong> <span id="detail-telefono"></span></div>
                                <div class="detail-info"><strong>Sexo:</strong> <span id="detail-sexo"></span></div>
                                <div class="detail-info"><strong>Edad:</strong> <span id="detail-edad"></span></div>
                            </div>
                            <div class="detail-section">
                                <h4>Informaci√≥n Electoral</h4>
                                <div class="detail-info"><strong>Centro de Votaci√≥n:</strong> <span id="detail-ubch"></span></div>
                                <div class="detail-info"><strong>Comunidad:</strong> <span id="detail-community"></span></div>
                                <div class="detail-info"><strong>Estado del Voto:</strong> <span id="detail-vote-status"></span></div>
                                <div class="detail-info"><strong>Fecha de Registro:</strong> <span id="detail-registered-at"></span></div>
                                <div class="detail-info"><strong>Registrado por:</strong> <span id="detail-registered-by"></span></div>
                            </div>
                            <div class="detail-section">
                                <h4>Acciones</h4>
                                <div class="detail-actions">
                                    <button class="btn btn-primary" onclick="votingSystem.editFromDetail()">üîÑ Editar</button>
                                    <button class="btn btn-success" onclick="votingSystem.confirmFromDetail()">üéØ Confirmar Voto</button>
                                    <button class="btn btn-danger" id="detail-delete-btn" onclick="votingSystem.deleteFromDetail()">‚ùå Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="loading-overlay" id="table-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                        <table id="registros-table" class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="header-checkbox" class="row-checkbox"></th>
                                    <th class="sortable-header" data-sort="name">Nombre ‚Üï</th>
                                    <th class="sortable-header" data-sort="cedula">C√©dula ‚Üï</th>
                                    <th class="sortable-header" data-sort="telefono">Tel√©fono ‚Üï</th>
                                    <th class="sortable-header" data-sort="sexo">Sexo ‚Üï</th>
                                    <th class="sortable-header" data-sort="edad">Edad ‚Üï</th>
                                    <th class="sortable-header" data-sort="ubch">Centro de Votaci√≥n ‚Üï</th>
                                    <th class="sortable-header" data-sort="community">Comunidad ‚Üï</th>
                                    <th class="sortable-header" data-sort="voted">Vot√≥ ‚Üï</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="pagination-container" class="pagination-container">
                            <div class="pagination-info">
                                Mostrando <span id="pagination-start">0</span> a <span id="pagination-end">0</span> de <span id="pagination-total">0</span> registros
                            </div>
                            <div class="pagination-controls">
                                <button class="pagination-btn" id="first-page">¬´ Primera</button>
                                <button class="pagination-btn" id="prev-page">‚Äπ Anterior</button>
                                <div id="page-numbers"></div>
                                <button class="pagination-btn" id="next-page">Siguiente ‚Ä∫</button>
                                <button class="pagination-btn" id="last-page">√öltima ¬ª</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div class="page" id="dashboard-page">
                <div class="page-container">
                    <h2 class="page-title">Totales Generales</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total de Personas Registradas</h3>
                            <p class="stat-number" id="total-registered">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total de Votos Confirmados</h3>
                            <p class="stat-number" id="total-voted">0</p>
                        </div>
                    </div>
                    <div class="progress-section">
                        <h3>Progreso de Votaci√≥n</h3>
                        <div id="progress-percentage" style="font-size:1.2em; font-weight:bold; margin-bottom:8px; color:#4f46e5;"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="vote-progress"></div>
                        </div>
                        <p class="progress-text" id="progress-text">0 de 0 personas han votado.</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Page -->
            <div class="page" id="statistics-page">
                <div class="page-container">
                    <div class="page-header">
                        <h2 class="page-title">Estad√≠sticas Detalladas</h2>
                        <div class="page-actions">
                            <button id="projection-btn" class="btn btn-primary">Modo Proyecci√≥n</button>
                            <button id="export-stats-pdf-btn" class="btn btn-secondary">Descargar PDF</button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stats-card">
                            <h3>Votos por Centro de Votaci√≥n</h3>
                            <div class="stats-list" id="ubch-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Comunidad</h3>
                            <div class="stats-list" id="community-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Sexo</h3>
                            <div class="stats-list" id="sexo-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Rango de Edad</h3>
                            <div class="stats-list" id="edad-stats"></div>
                        </div>
                    </div>
                    <!-- Al final de la secci√≥n de estad√≠sticas (antes de cerrar la page-container de statistics-page): -->
                    <div class="stats-projection-section">
                                              <h3 style="margin-top:2em;">Resumen por Centro de Votaci√≥n</h3>
                      <div id="stats-projection-list" class="projection-list"></div>
                    </div>
                </div>
            </div>

            <!-- Verifier Dashboard Page -->
            <div class="page" id="verifier-dashboard-page">
                <div class="page-container">
                    <h2 class="page-title">üìä Mi Dashboard de Verificaci√≥n</h2>
                    
                    <!-- Resumen de actividad personal -->
                    <div class="verifier-stats-grid">
                        <div class="verifier-stat-card">
                            <h3>üéØ Confirmaciones Hoy</h3>
                            <p class="verifier-stat-number" id="verifier-today-confirmations">0</p>
                            <p class="verifier-stat-label">votos confirmados hoy</p>
                        </div>
                        <div class="verifier-stat-card">
                            <h3>üìà Confirmaciones Esta Semana</h3>
                            <p class="verifier-stat-number" id="verifier-week-confirmations">0</p>
                            <p class="verifier-stat-label">votos confirmados esta semana</p>
                        </div>
                        <div class="verifier-stat-card">
                            <h3>üìä Total Personal</h3>
                            <p class="verifier-stat-number" id="verifier-total-confirmations">0</p>
                            <p class="verifier-stat-label">votos confirmados en total</p>
                        </div>
                        <div class="verifier-stat-card">
                            <h3>‚è±Ô∏è Promedio por Hora</h3>
                            <p class="verifier-stat-number" id="verifier-hourly-average">0</p>
                            <p class="verifier-stat-label">confirmaciones por hora</p>
                        </div>
                    </div>

                    <!-- Gr√°fico de actividad por hora -->
                    <div class="verifier-chart-section">
                        <h3>üìä Mi Actividad por Hora (Hoy)</h3>
                        <div class="verifier-chart-container">
                            <canvas id="verifier-activity-chart"></canvas>
                        </div>
                    </div>

                    <!-- Estad√≠sticas por CV -->
                    <div class="verifier-cv-stats">
                        <h3>üèõÔ∏è Mis Confirmaciones por Centro de Votaci√≥n</h3>
                        <div class="verifier-cv-list" id="verifier-cv-stats-list">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- √öltimas confirmaciones -->
                    <div class="verifier-recent-section">
                        <h3>üïí Mis √öltimas Confirmaciones</h3>
                        <div class="verifier-recent-list" id="verifier-recent-confirmations">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verifier History Page -->
            <div class="page" id="verifier-history-page">
                <div class="page-container">
                    <h2 class="page-title">üìã Mi Historial de Confirmaciones</h2>
                    
                    <!-- Filtros de b√∫squeda -->
                    <div class="verifier-history-filters">
                        <div class="filter-group">
                            <label for="verifier-date-filter">Fecha:</label>
                            <select id="verifier-date-filter">
                                <option value="">Todas las fechas</option>
                                <option value="today">Hoy</option>
                                <option value="yesterday">Ayer</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="verifier-cv-filter">Centro de Votaci√≥n:</label>
                            <select id="verifier-cv-filter">
                                <option value="">Todos los CV</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="verifier-search">Buscar:</label>
                            <input type="text" id="verifier-search" placeholder="Buscar por nombre o c√©dula...">
                        </div>
                        <button class="btn btn-primary" onclick="verifierFilterHistory()">üîç Filtrar</button>
                        <button class="btn btn-secondary" onclick="verifierExportHistory()">üìä Exportar</button>
                    </div>

                    <!-- Tabla de historial -->
                    <div class="verifier-history-table-container">
                        <table class="verifier-history-table" id="verifier-history-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Nombre</th>
                                    <th>C√©dula</th>
                                    <th>CV</th>
                                    <th>Comunidad</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="verifier-history-tbody">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div class="verifier-pagination" id="verifier-pagination">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Registrator Dashboard Page -->
            <div class="page" id="registrator-dashboard-page">
                <div class="page-container">
                    <h2 class="page-title">üìä Mi Dashboard de Registro</h2>
                    
                    <!-- Resumen de actividad personal -->
                    <div class="registrator-stats-grid">
                        <div class="registrator-stat-card">
                            <h3>üìù Registros Hoy</h3>
                            <p class="registrator-stat-number" id="registrator-today-registrations">0</p>
                            <p class="registrator-stat-label">personas registradas hoy</p>
                        </div>
                        <div class="registrator-stat-card">
                            <h3>üìà Registros Esta Semana</h3>
                            <p class="registrator-stat-number" id="registrator-week-registrations">0</p>
                            <p class="registrator-stat-label">personas registradas esta semana</p>
                        </div>
                        <div class="registrator-stat-card">
                            <h3>üìä Total Personal</h3>
                            <p class="registrator-stat-number" id="registrator-total-registrations">0</p>
                            <p class="registrator-stat-label">personas registradas en total</p>
                        </div>
                        <div class="registrator-stat-card">
                            <h3>‚è±Ô∏è Promedio por Hora</h3>
                            <p class="registrator-stat-number" id="registrator-hourly-average">0</p>
                            <p class="registrator-stat-label">registros por hora</p>
                        </div>
                    </div>

                    <!-- Estad√≠sticas de tipos de registro -->
                    <div class="registrator-stats-grid" style="margin-top: 2rem;">
                        <div class="registrator-stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h3>üë§ Registros Individuales</h3>
                            <p class="registrator-stat-number" id="registrator-individual-count">0</p>
                            <p class="registrator-stat-label">registros uno por uno</p>
                        </div>
                        <div class="registrator-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <h3>üìä Registros Masivos</h3>
                            <p class="registrator-stat-number" id="registrator-bulk-count">0</p>
                            <p class="registrator-stat-label">registros por lotes</p>
                        </div>
                    </div>

                    <!-- Gr√°fico de actividad por hora -->
                    <div class="registrator-chart-section">
                        <h3>üìä Mi Actividad por Hora (Hoy)</h3>
                        <div class="registrator-chart-container">
                            <canvas id="registrator-activity-chart"></canvas>
                        </div>
                    </div>

                    <!-- Estad√≠sticas por CV -->
                    <div class="registrator-cv-stats">
                        <h3>üèõÔ∏è Mis Registros por Centro de Votaci√≥n</h3>
                        <div class="registrator-cv-list" id="registrator-cv-stats-list">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- √öltimos registros -->
                    <div class="registrator-recent-section">
                        <h3>üïí Mis √öltimos Registros</h3>
                        <div class="registrator-recent-list" id="registrator-recent-registrations">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registrator History Page -->
            <div class="page" id="registrator-history-page">
                <div class="page-container">
                    <h2 class="page-title">üìã Mi Historial de Registros</h2>
                    
                    <!-- Filtros de b√∫squeda -->
                    <div class="registrator-history-filters">
                        <div class="filter-group">
                            <label for="registrator-date-filter">Fecha:</label>
                            <select id="registrator-date-filter">
                                <option value="">Todas las fechas</option>
                                <option value="today">Hoy</option>
                                <option value="yesterday">Ayer</option>
                                <option value="week">Esta semana</option>
                                <option value="month">Este mes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="registrator-cv-filter">Centro de Votaci√≥n:</label>
                            <select id="registrator-cv-filter">
                                <option value="">Todos los CV</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="registrator-search">Buscar:</label>
                            <input type="text" id="registrator-search" placeholder="Buscar por nombre o c√©dula...">
                        </div>
                        <div class="filter-group">
                            <label for="registrator-voted-filter">Estado de Voto:</label>
                            <select id="registrator-voted-filter">
                                <option value="">Todos</option>
                                <option value="true">‚úÖ Vot√≥</option>
                                <option value="false">‚ùå No vot√≥</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="registratorFilterHistory()">üîç Filtrar</button>
                        <button class="btn btn-secondary" onclick="registratorExportHistory()">üìä Exportar</button>
                    </div>

                    <!-- Tabla de historial -->
                    <div class="registrator-history-table-container">
                        <table class="registrator-history-table" id="registrator-history-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Nombre</th>
                                    <th>C√©dula</th>
                                    <th>Tel√©fono</th>
                                    <th>Sexo</th>
                                    <th>Edad</th>
                                    <th>CV</th>
                                    <th>Comunidad</th>
                                    <th>Tipo</th>
                                    <th>¬øVot√≥?</th>
                                </tr>
                            </thead>
                            <tbody id="registrator-history-tbody">
                                <!-- Se llenar√° din√°micamente -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div class="registrator-pagination" id="registrator-pagination">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Projection View -->
        <div id="projection-view" class="projection-view" style="display: none;">
            <div class="projection-header">
                <h1>Proyecci√≥n en Tiempo Real</h1>
                <button id="exit-projection-btn" class="btn btn-danger">Salir</button>
            </div>
            <div class="projection-content">
                <div class="projection-main">
                    <h2>Participaci√≥n General</h2>
                    <div class="projection-number" id="projection-votes">0</div>
                    <div class="projection-label">Votos</div>
                    <div class="projection-progress">
                        <div class="projection-progress-fill" id="projection-progress-fill"></div>
                    </div>
                    <p class="projection-text" id="projection-text">0 de 0</p>
                </div>
                <div class="projection-stats">
                                            <h2>Votos por Centro de Votaci√≥n</h2>
                    <div class="projection-list" id="projection-ubch-list"></div>
                </div>
            </div>
            <div class="projection-footer">
                <div class="logo-container" style="width:60px; height:60px; margin-right:1.2em;">
                    <img src="logo.jpg" alt="Logo Sistema de Votos" class="header-logo">
                </div>
                <span style="font-size:1.2em; font-family:'Inter',Arial,sans-serif; font-weight:600; letter-spacing:0.5px;">Logo Sistema de Registro de Votos 2025 &bull; Desarrollado por la VR</span>
            </div>
        </div>

        <!-- Modals -->
        <div id="delete-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Confirmar Eliminaci√≥n</h3>
                <p>¬øEst√°s seguro de que deseas eliminar este registro? Esta acci√≥n no se puede deshacer.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-delete">Cancelar</button>
                    <button class="btn btn-danger" id="confirm-delete">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Edici√≥n -->
        <div id="edit-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Editar Registro</h3>
                <form id="edit-form" class="edit-form">
                    <div class="form-group">
                        <label for="edit-community">Comunidad</label>
                        <select id="edit-community" name="community" required>
                            <option value="">Selecciona una comunidad</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-name">Nombre</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-cedula">C√©dula</label>
                        <input type="text" id="edit-cedula" name="cedula" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-telefono">Tel√©fono (opcional)</label>
                        <input type="text" id="edit-telefono" name="telefono">
                    </div>
                    <div class="form-group">
                        <label for="edit-sexo">Sexo</label>
                        <select id="edit-sexo" name="sexo" required>
                            <option value="">Selecciona el sexo</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-edad">Edad</label>
                        <input type="number" id="edit-edad" name="edad" min="16" max="120" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-ubch">Centro de Votaci√≥n</label>
                        <select id="edit-ubch" name="ubch" required>
                            <option value="">Selecciona un Centro de Votaci√≥n</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-edit">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="save-edit">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2025 Registro de Votos y Estad√≠sticas. Todos los derechos reservados.</p>
        </footer>
    </div>

    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="sync-manager.js"></script>
    <script src="service-manager.js"></script>
    <script src="init-system.js"></script>
    <script src="choices.min.js"></script>
    <script src="diagnostico-registro-masivo.js"></script>
    
    <!-- Funciones globales -->
    <script>
        // Funci√≥n para alternar men√∫ m√≥vil (acorde√≥n)
        window.toggleMenu = function() {
            const menuDropdown = document.getElementById('menu-dropdown');
            const menuToggle = document.querySelector('.menu-toggle');
            
            if (menuDropdown) {
                const isActive = menuDropdown.classList.contains('active');
                
                if (isActive) {
                    // Cerrar men√∫ con animaci√≥n
                    menuDropdown.classList.remove('active');
                    if (menuToggle) {
                        menuToggle.textContent = '‚ãÆ';
                        menuToggle.style.transform = 'rotate(0deg)';
                    }
                } else {
                    // Abrir men√∫ con animaci√≥n
                    menuDropdown.classList.add('active');
                    if (menuToggle) {
                        menuToggle.textContent = '‚úï';
                        menuToggle.style.transform = 'rotate(180deg)';
                    }
                }
            }
        };

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', function(event) {
            const mobileMenu = document.querySelector('.mobile-menu');
            const menuDropdown = document.getElementById('menu-dropdown');
            const menuToggle = document.querySelector('.menu-toggle');
            
            if (mobileMenu && !mobileMenu.contains(event.target) && menuDropdown) {
                menuDropdown.classList.remove('active');
                if (menuToggle) {
                    menuToggle.textContent = '‚ãÆ';
                    menuToggle.style.transform = 'rotate(0deg)';
                }
            }
        });

        // Funci√≥n para filtrar historial del registrador
        window.registratorFilterHistory = function() {
            if (window.votingSystem) {
                const currentUser = window.votingSystem.getCurrentUser();
                if (currentUser && currentUser.rol === 'registrador') {
                    const registrations = window.votingSystem.getRegistratorRegistrations(currentUser.username);
                    const filteredRegistrations = window.votingSystem.applyRegistratorFilters(registrations);
                    window.votingSystem.renderRegistratorHistoryTable(filteredRegistrations);
                }
            }
        };

        // Funci√≥n para exportar historial del registrador
        window.registratorExportHistory = function() {
            if (window.votingSystem) {
                window.votingSystem.exportRegistratorHistory();
            }
        };
        

    </script>
    
    <script>
        const USUARIOS_INICIALES = [
            // Superusuarios
            { username: "diego corrales", password: "alcalde1", rol: "superusuario" },
            { username: "victor", password: "admin", rol: "superusuario" },
            { username: "superadmin_01", password: "Sup3r_Adm1n#2o24", rol: "superusuario" },
            { username: "superadmin_02", password: "aB5!zP9$qW_sU", rol: "superusuario" },
            { username: "superadmin_03", password: "rT7@eX3&yU_sU", rol: "superusuario" },
            { username: "superadmin_04", password: "kL9#mN1!bV_sU", rol: "superusuario" },
            { username: "superadmin_05", password: "zX8$cV6@fG_sU", rol: "superusuario" },
            // Administradores
            { username: "admin_01", password: "P@ssw0rd_Adm_01", rol: "admin" },
            { username: "admin_02", password: "Adm_Secure_02!", rol: "admin" },
            { username: "admin_03", password: "Gestion_2024_03", rol: "admin" },
            { username: "admin_04", password: "4dminUser_p4ss", rol: "admin" },
            { username: "admin_05", password: "Adm!n_Syst3m_05", rol: "admin" },
            { username: "admin_06", password: "UserAdmin_06#", rol: "admin" },
            { username: "admin_07", password: "Control_Panel_07", rol: "admin" },
            { username: "admin_08", password: "Adm_Access_08$", rol: "admin" },
            { username: "admin_09", password: "My_Admin_P@ss09", rol: "admin" },
            { username: "admin_10", password: "P@ss_Adm_Global", rol: "admin" },
            // Registradores
            { username: "registrador_01", password: "RegUsr_2o24_01", rol: "registrador" },
            { username: "registrador_02", password: "UserReg_Pass_02", rol: "registrador" },
            { username: "registrador_03", password: "Reg!strador_03", rol: "registrador" },
            { username: "registrador_04", password: "Acc3s_Reg_04", rol: "registrador" },
            { username: "registrador_05", password: "DataEntry_05$", rol: "registrador" },
            { username: "registrador_06", password: "RegUsr_2o24_06", rol: "registrador" },
            { username: "registrador_07", password: "UserReg_Pass_07", rol: "registrador" },
            { username: "registrador_08", password: "Reg!strador_08", rol: "registrador" },
            { username: "registrador_09", password: "Acc3s_Reg_09", rol: "registrador" },
            { username: "registrador_10", password: "DataEntry_10$", rol: "registrador" },
            { username: "registrador_11", password: "RegUsr_2o24_11", rol: "registrador" },
            { username: "registrador_12", password: "UserReg_Pass_12", rol: "registrador" },
            { username: "registrador_13", password: "Reg!strador_13", rol: "registrador" },
            { username: "registrador_14", password: "Acc3s_Reg_14", rol: "registrador" },
            { username: "registrador_15", password: "DataEntry_15$", rol: "registrador" },
            { username: "registrador_16", password: "RegUsr_2o24_16", rol: "registrador" },
            { username: "registrador_17", password: "UserReg_Pass_17", rol: "registrador" },
            { username: "registrador_18", password: "Reg!strador_18", rol: "registrador" },
            { username: "registrador_19", password: "Acc3s_Reg_19", rol: "registrador" },
            { username: "registrador_20", password: "DataEntry_20$", rol: "registrador" },
            { username: "registrador_21", password: "RegUsr_2o24_21", rol: "registrador" },
            { username: "registrador_22", password: "UserReg_Pass_22", rol: "registrador" },
            { username: "registrador_23", password: "Reg!strador_23", rol: "registrador" },
            { username: "registrador_24", password: "Acc3s_Reg_24", rol: "registrador" },
            { username: "registrador_25", password: "DataEntry_25$", rol: "registrador" },
            { username: "registrador_26", password: "RegUsr_2o24_26", rol: "registrador" },
            { username: "registrador_27", password: "UserReg_Pass_27", rol: "registrador" },
            { username: "registrador_28", password: "Reg!strador_28", rol: "registrador" },
            { username: "registrador_29", password: "Acc3s_Reg_29", rol: "registrador" },
            { username: "registrador_30", password: "DataEntry_30$", rol: "registrador" },
            { username: "registrador_31", password: "RegUsr_2o24_31", rol: "registrador" },
            { username: "registrador_32", password: "UserReg_Pass_32", rol: "registrador" },
            { username: "registrador_33", password: "Reg!strador_33", rol: "registrador" },
            { username: "registrador_34", password: "Acc3s_Reg_34", rol: "registrador" },
            { username: "registrador_35", password: "DataEntry_35$", rol: "registrador" },
            { username: "registrador_36", password: "RegUsr_2o24_36", rol: "registrador" },
            { username: "registrador_37", password: "UserReg_Pass_37", rol: "registrador" },
            { username: "registrador_38", password: "Reg!strador_38", rol: "registrador" },
            { username: "registrador_39", password: "Acc3s_Reg_39", rol: "registrador" },
            { username: "registrador_40", password: "DataEntry_40$", rol: "registrador" },
            { username: "registrador_41", password: "RegUsr_2o24_41", rol: "registrador" },
            { username: "registrador_42", password: "UserReg_Pass_42", rol: "registrador" },
            { username: "registrador_43", password: "Reg!strador_43", rol: "registrador" },
            { username: "registrador_44", password: "Acc3s_Reg_44", rol: "registrador" },
            { username: "registrador_45", password: "DataEntry_45$", rol: "registrador" },
            { username: "registrador_46", password: "RegUsr_2o24_46", rol: "registrador" },
            { username: "registrador_47", password: "UserReg_Pass_47", rol: "registrador" },
            { username: "registrador_48", password: "Reg!strador_48", rol: "registrador" },
            { username: "registrador_49", password: "Acc3s_Reg_49", rol: "registrador" },
            { username: "registrador_50", password: "RegUsr_Final_50", rol: "registrador" },
            // Nuevos registradores con nombres reales
            { username: "YRAIMA PINTO", password: "13518010", rol: "registrador" },
            { username: "DARRY OVIEDO", password: "13202937", rol: "registrador" },
            { username: "IBIRMA GONZALEZ", password: "6846374", rol: "registrador" },
            { username: "HEIDY AVENDA√ëO", password: "13087047", rol: "registrador" },
            { username: "LILIANGEL RODRIGUEZ", password: "23432113", rol: "registrador" },
            { username: "LEOWALDO SEGOVIA", password: "16243232", rol: "registrador" },
            { username: "LIDA SANCHEZ", password: "7933221", rol: "registrador" },
            { username: "NINA MORENO", password: "15055595", rol: "registrador" },
            { username: "CARLOS AVENDA√ëO", password: "4885476", rol: "registrador" },
            { username: "KATIUSKA VERGARA", password: "13455771", rol: "registrador" },
            { username: "GLADYS MARTINEZ", password: "6372937", rol: "registrador" },
            { username: "DENNYS LOPEZ", password: "15654130", rol: "registrador" },
            { username: "YNGRID FERNANDEZ", password: "11345082", rol: "registrador" },
            { username: "MAYRA CONTRERAS", password: "14899707", rol: "registrador" },
            { username: "NAHIMA DALYS", password: "13954994", rol: "registrador" },
            { username: "JAVIER PEREZ", password: "10730988", rol: "registrador" },
            { username: "YELIDA LARA", password: "7380194", rol: "registrador" },
            { username: "SUGIR MU√ëOZ", password: "17530417", rol: "registrador" },
            { username: "AMILCAR JASPE", password: "18532546", rol: "registrador" },
            { username: "MILAGROS VILLEGAS", password: "11098987", rol: "registrador" },
            { username: "REINA RODRIGUEZ", password: "14717754", rol: "registrador" },
            { username: "IRIS CABELLO", password: "5268555", rol: "registrador" },
            { username: "FERNANDA QUINTERO", password: "13236761", rol: "registrador" },
            { username: "YSABEL RIVAS", password: "18532837", rol: "registrador" },
            { username: "YETSURY SANCHEZ", password: "20759670", rol: "registrador" },
            { username: "JANETH FLORES", password: "8830118", rol: "registrador" },
            { username: "CANDIDA FERNANDEZ", password: "13646202", rol: "registrador" },
            { username: "FRANYELIS SEQUERA", password: "15609598", rol: "registrador" },
            { username: "MAIKEL ANDRADE", password: "16542701", rol: "registrador" },
            { username: "ZAYDA HERNANDEZ", password: "5698961", rol: "registrador" },
            { username: "FRANCIS CONTRERAS", password: "15581776", rol: "registrador" },
            { username: "ANAHIS ACEVEDO", password: "5338471", rol: "registrador" },
            { username: "JESUS GUZMAN", password: "11943006", rol: "registrador" },
            { username: "CANDELARIA RAMOS", password: "9848204", rol: "registrador" },
            { username: "JESUS CALDERON", password: "11987291", rol: "registrador" },
            { username: "LILIA JUAREZ", password: "5362888", rol: "registrador" },
            { username: "YUNEIDY PINTO", password: "20699632", rol: "registrador" },
            { username: "ELIZABETH AGUIAR", password: "15333071", rol: "registrador" },
            { username: "JHOAN ANGEL", password: "19772158", rol: "registrador" },
            { username: "ALBANI HERRERA", password: "23430503", rol: "registrador" },
            { username: "YOSAINI ESCOBAR", password: "18167185", rol: "registrador" },
            { username: "LUIS GUTIERREZ", password: "19667240", rol: "registrador" },
            { username: "MARIA HERIBERTA TOVAR", password: "5370901", rol: "registrador" },
            { username: "LISANDRA CORONA", password: "24518796", rol: "registrador" },
            { username: "ANDREINA FERNANDEZ", password: "20941865", rol: "registrador" },
            { username: "MILAGROS DIAZ", password: "9692529", rol: "registrador" },
            { username: "JESUS HERRERA", password: "12118763", rol: "registrador" },
            { username: "LEIDY BARRIOS", password: "18166116", rol: "registrador" },
            { username: "ROBERSY VASQUEZ", password: "16864029", rol: "registrador" },
            { username: "SANTIAGO LOYO", password: "22005127", rol: "registrador" },
            { username: "SIKIU GARCIA", password: "11165709", rol: "registrador" },
            { username: "EFRAIN CHIRINOS", password: "12604184", rol: "registrador" },
            { username: "ENEIDA MARQUEZ", password: "11150347", rol: "registrador" },
            { username: "NEIDA FLORES", password: "15161126", rol: "registrador" },
            { username: "MARYURI BENAVENTA", password: "13454809", rol: "registrador" },
            { username: "ADRIANA LA CRUZ", password: "13900179", rol: "registrador" },
            { username: "LINYU SALCEDO", password: "15259454", rol: "registrador" },
            { username: "YENIFER CORZO", password: "16205348", rol: "registrador" },
            { username: "JANET GUZMAN", password: "9679125", rol: "registrador" },
            { username: "INGRID CESAR", password: "12856450", rol: "registrador" },
            { username: "YOSYMAR MONSALVE", password: "19364063", rol: "registrador" },
            { username: "JANETH FUENTES", password: "15258472", rol: "registrador" },
            { username: "LUIS OLIVEROS", password: "3920033", rol: "registrador" },
            { username: "CARLOS GUTIERREZ", password: "14355085", rol: "registrador" },
            { username: "MIRIAM ESTRADA", password: "15259811", rol: "registrador" },
            { username: "IVAN ANTEQUERA", password: "15407161", rol: "registrador" },
            { username: "LUISA DE CHACON", password: "8520238", rol: "registrador" },
            { username: "GENESIS MEDINAS", password: "21584875", rol: "registrador" },
            { username: "AIRAM SAMBRANO", password: "20243594", rol: "registrador" },
            { username: "EUGERY RIVAS", password: "14051835", rol: "registrador" },
            { username: "LEONEL SEQUERA", password: "12343202", rol: "registrador" },
            // Verificadores de votos
            { username: "maria ordo√±ez", password: "20161765", rol: "verificador" },
            { username: "reinaldo aguilar", password: "12478928", rol: "verificador" },
            { username: "ana alvarez", password: "12341809", rol: "verificador" },
            { username: "perla valera", password: "7257936", rol: "verificador" },
            { username: "willy garcia", password: "18639693", rol: "verificador" },
            { username: "iris marquez", password: "16581399", rol: "verificador" },
            { username: "justo perez", password: "18867076", rol: "verificador" },
            { username: "jose rodriguez", password: "26389924", rol: "verificador" },
            { username: "nereyda guerrero", password: "8823392", rol: "verificador" },
            { username: "yoiny betancourt", password: "26804061", rol: "verificador" },
            { username: "erminia pulido", password: "14713807", rol: "verificador" },
            { username: "jonas cordoba", password: "25981075", rol: "verificador" },
            { username: "luis barcasnegra", password: "14754397", rol: "verificador" },
            { username: "jose ledezma", password: "11177021", rol: "verificador" },
            { username: "herminia leon", password: "11353776", rol: "verificador" },
            { username: "darlis botello", password: "9535936", rol: "verificador" },
            { username: "miguel hernandez", password: "9658902", rol: "verificador" },
            { username: "hipolita molina", password: "7073680", rol: "verificador" },
            { username: "fidel ernesto aguilar", password: "7091235", rol: "verificador" }
        ];

        function showMessage(message, type = 'info') {
            const loginMessage = document.getElementById('login-message');
            loginMessage.textContent = message;
            loginMessage.className = `login-message ${type}`;
            loginMessage.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { loginMessage.style.display = 'none'; }, 3000);
            }
        }

        function renderLoginForm() {
            return `
                <div class="login-container">
                    <div class="login-header">
                        <img src="logo.jpg" alt="Logo Sistema de Votos">
                        <h1>Bienvenido</h1>
                        <p>Sistema de Registro de Votos 2025</p>
                    </div>
                    <div id="login-message" class="login-message" style="display:none;"></div>
                    <form id="login-form" class="login-form">
                        <div class="form-group">
                            <label for="username">Usuario</label>
                            <input type="text" id="username" name="username" placeholder="Ingresa tu usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contrase√±a</label>
                            <input type="password" id="password" name="password" placeholder="Ingresa tu contrase√±a" required>
                        </div>
                        <button type="submit" class="login-btn" id="login-btn">
                            <span class="btn-text">Iniciar Sesi√≥n</span>
                            <span class="btn-loading" style="display:none;"><div class="spinner"></div>Iniciando sesi√≥n...</span>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderAppContent(user) {
            // Aqu√≠ puedes mostrar el contenido real de la app seg√∫n el rol
            // Ejemplo b√°sico:
            return `<div class="app-content">
                <h2>¬°Hola, ${user.username}!</h2>
                <p>Tu rol es: <strong>${user.rol}</strong></p>
                <button onclick="logout()">Cerrar Sesi√≥n</button>
                <!-- Aqu√≠ va el resto de la app -->
            </div>`;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionTime');
            window.location.href = 'login.html';
        }

        function checkSession() {
            const currentUser = localStorage.getItem('currentUser');
            const sessionTime = localStorage.getItem('sessionTime');
            
            if (!currentUser) {
                window.location.href = 'login.html';
                        return;
            }
            
            // Verificar si la sesi√≥n ha expirado (24 horas)
            if (sessionTime && (Date.now() - parseInt(sessionTime)) > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('sessionTime');
                window.location.href = 'login.html';
                return;
            }
            
            // Mostrar informaci√≥n del usuario
            try {
                const user = JSON.parse(currentUser);
                const userInfo = document.getElementById('userId');
                if (userInfo) {
                    userInfo.textContent = `${user.username} (${user.rol})`;
                }
            } catch (error) {
                console.error('Error al mostrar informaci√≥n del usuario:', error);
            }
        }

        // === MIS REGISTROS - USANDO DATOS DEL PANEL DE ADMINISTRACI√ìN ===
        window.renderMyRecordsTable = async function() {
            const tableBody = document.querySelector('#myrecords-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="8">Cargando...</td></tr>';
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const username = normalizarUsuario(currentUser.username || '');
                if (!username) {
                    tableBody.innerHTML = '<tr><td colspan="8">No hay usuario activo</td></tr>';
                    return;
                }
                
                // Cargar datos desde Firebase (igual que en admin-panel)
                const snapshot = await window.firebaseDB.votesCollection.where('registeredBy', '==', username).get();
                const allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Filtrar por el usuario actual
                const misRegistros = allUsers.filter(user => 
                    (user.registeredBy || '').trim().toLowerCase() === username
                );
                
                if (misRegistros.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8">No tienes registros propios a√∫n.</td></tr>';
                    return;
                }
                
                // Renderizar tabla
                let rows = '';
                misRegistros.forEach(d => {
                    rows += `<tr>
                        <td>${d.name || ''}</td>
                        <td>${d.cedula || ''}</td>
                        <td>${d.telefono || ''}</td>
                        <td>${d.sexo || ''}</td>
                        <td>${d.edad || ''}</td>
                        <td>${d.ubch || ''}</td>
                        <td>${d.community || ''}</td>
                        <td>${d.registeredAt ? (new Date(d.registeredAt)).toLocaleString('es-VE', {hour12:true}) : ''}</td>
                    </tr>`;
                });
                tableBody.innerHTML = rows;
                
                console.log(`‚úÖ Mis Registros: ${misRegistros.length} registros encontrados para ${username}`);
                
            } catch (error) {
                console.error('‚ùå Error cargando Mis Registros:', error);
                tableBody.innerHTML = '<tr><td colspan="8">Error cargando registros</td></tr>';
            }
        };

        // Descargar los registros del usuario actual como CSV
        window.downloadMyRecordsAsCSV = async function() {
            // Consultar solo la cola local
            let registrosLocales = [];
            if (window.offlineQueueManager && typeof window.offlineQueueManager.obtenerColaLocal === 'function') {
                try {
                    registrosLocales = window.offlineQueueManager.obtenerColaLocal();
                } catch (e) {
                    console.error('Error consultando cola local:', e);
                }
            }
            if (!registrosLocales || registrosLocales.length === 0) {
                alert('No tienes registros propios a√∫n.');
                return;
            }
            // Generar CSV con punto y coma y BOM UTF-8
            let csv = 'Nombre;C√©dula;Tel√©fono;Sexo;Edad;UBCH;Comunidad;Fecha\n';
            registrosLocales.forEach(d => {
                csv += `"${d.name||''}";"${d.cedula||''}";"${d.telefono||''}";"${d.sexo||''}";"${d.edad||''}";"${d.ubch||''}";"${d.community||''}";"${d.registeredAt ? (new Date(d.registeredAt)).toLocaleString('es-VE', {hour12:true}) : ''}"\n`;
            });
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mis_registros.csv';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        }

        // Mostrar la tabla cada vez que se entra en la secci√≥n
        if (typeof switchRegistrationMode === 'function') {
            const oldSwitch = switchRegistrationMode;
            window.switchRegistrationMode = function(mode) {
                oldSwitch(mode);
                if (mode === 'myrecords') {
                    setTimeout(() => {
                        window.renderMyRecordsTable();
                    }, 100);
                }
            };
        }

        // Funci√≥n para normalizar el nombre de usuario (min√∫sculas y sin espacios extra)
        function normalizarUsuario(username) {
            return (username || '').trim().toLowerCase();
        }

        // Sistema de inicializaci√≥n manejado por init-system.js

        // Variables para registro masivo
        let bulkRegistrations = [];
        let bulkFile = null;

        // --- Persistencia temporal del formulario y modo de registro ---
        function saveRegistrationDraft() {
            const mode = localStorage.getItem('registrationMode') || 'individual';
            const draft = { mode };
            if (mode === 'individual') {
                const form = document.getElementById('registration-form');
                if (form) {
                    draft.ubch = form.ubch ? form.ubch.value : '';
                    draft.community = form.community ? form.community.value : '';
                    draft.name = form.name ? form.name.value : '';
                    draft.cedula = form.cedula ? form.cedula.value : '';
                    draft.telefono = form.telefono ? form.telefono.value : '';
                    draft.sexo = form.sexo ? form.sexo.value : '';
                    draft.edad = form.edad ? form.edad.value : '';
                }
            }
            localStorage.setItem('registrationDraft', JSON.stringify(draft));
        }

        // Solo restaurar el draft una vez al cargar la p√°gina
        let registrationDraftRestored = false;
        function restoreRegistrationDraftOnce() {
            if (registrationDraftRestored) return;
            registrationDraftRestored = true;
            const draftStr = localStorage.getItem('registrationDraft');
            if (!draftStr) return;
            let draft;
            try {
                draft = JSON.parse(draftStr);
            } catch (e) { return; }
            if (draft.mode) {
                switchRegistrationMode(draft.mode);
            }
            if (draft.mode === 'individual') {
                const form = document.getElementById('registration-form');
                if (form) {
                    form._pendingDraft = draft;
                    setRegistrationDraftValues(form, draft);
                }
            }
        }

        function setRegistrationDraftValues(form, draft) {
            // Asigna los valores del borrador si existen las opciones
            if (form.ubch && draft.ubch) {
                form.ubch.value = draft.ubch;
            }
            if (form.community && draft.community) {
                form.community.value = draft.community;
            }
            if (form.name) form.name.value = draft.name || '';
            if (form.cedula) form.cedula.value = draft.cedula || '';
            if (form.telefono) form.telefono.value = draft.telefono || '';
            if (form.sexo) form.sexo.value = draft.sexo || '';
            if (form.edad) form.edad.value = draft.edad || '';
        }

        function clearRegistrationDraft() {
            localStorage.removeItem('registrationDraft');
        }

        // Elimina cualquier refresco autom√°tico de selects por eventos personalizados
        // (No volver a llamar a onUBCHAndCommunityLoaded ni restaurar draft por eventos)

        // Configurar el input de archivo para registro masivo
        document.addEventListener('DOMContentLoaded', function() {
            // Limpiar draft de registro al cargar la p√°gina
            clearRegistrationDraft();
            const bulkFileInput = document.getElementById('bulk-excel-input');
            if (bulkFileInput) {
                bulkFileInput.addEventListener('change', handleBulkFileSelect);
            }
            // Forzar modo individual al cargar
            switchRegistrationMode('individual');
            // Restaurar draft SOLO una vez al cargar la p√°gina
            setTimeout(restoreRegistrationDraftOnce, 200);
        });

        // Al enviar el formulario, guardar el draft actualizado y limpiar si es necesario
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registration-form');
            if (form) {
                form.addEventListener('submit', function() {
                    saveRegistrationDraft();
                    // Si quieres limpiar el draft tras registro exitoso, llama a clearRegistrationDraft() despu√©s del registro
                });
            }
        });



        // === FUNCIONES PARA REGISTRO MASIVO SIMPLE ===
        
        // Variables para el registro masivo
        let pasteTable, pasteTableBody, importStatus;

        // Inicializar elementos cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            pasteTable = document.getElementById('paste-table');
            pasteTableBody = document.getElementById('paste-table-body');
            importStatus = document.getElementById('import-massive-status');

            // Permitir pegar datos desde Excel
            if (pasteTable) {
                pasteTable.addEventListener('paste', function (e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    const rows = text.split('\n').filter(row => row.trim() !== '');
                    pasteTableBody.innerHTML = '';
                    
                    rows.forEach(row => {
                        const cols = row.split('\t');
                        const tr = document.createElement('tr');
                        
                        // Mapear datos seg√∫n el n√∫mero de columnas
                        let mappedData = [];
                        if (cols.length === 4) {
                            // Formato: C√©dula, Tel√©fono, Sexo, Edad
                            mappedData = [
                                window.configuracionRegistroMasivo?.centroVotacion || 'GRUPO ESCOLAR DOCTOR RAFAEL PEREZ',
                                window.configuracionRegistroMasivo?.comunidad || 'ALTAMIRA',
                                window.configuracionRegistroMasivo?.nombrePorDefecto || 'NOMBRE POR DEFINIR',
                                cols[0] || '', // C√©dula
                                cols[1] || '', // Tel√©fono
                                cols[2] || '', // Sexo
                                cols[3] || ''  // Edad
                            ];
                        } else if (cols.length === 7) {
                            // Formato completo: Centro, Comunidad, Nombre, C√©dula, Tel√©fono, Sexo, Edad
                            mappedData = cols;
                        } else {
                            // Otros formatos, usar los datos disponibles
                            mappedData = [
                                cols[0] || '', // Centro de Votaci√≥n
                                cols[1] || '', // Comunidad
                                cols[2] || '', // Nombre
                                cols[3] || '', // C√©dula
                                cols[4] || '', // Tel√©fono
                                cols[5] || '', // Sexo
                                cols[6] || ''  // Edad
                            ];
                        }
                        
                        // Crear siempre 8 celdas (7 datos + 1 estado)
                        for (let i = 0; i < 8; i++) {
                            const td = document.createElement('td');
                            if (i < 7) {
                                td.contentEditable = 'true';
                                td.style.padding = '1rem 0.75rem';
                                td.style.borderBottom = '1px solid #dee2e6';
                                td.style.minWidth = i < 3 ? '150px' : i < 5 ? '120px' : '80px';
                                td.textContent = mappedData[i] || '';
                            } else {
                                // Celda de estado (no editable)
                                td.style.padding = '1rem 0.75rem';
                                td.style.borderBottom = '1px solid #dee2e6';
                                td.style.minWidth = '100px';
                                td.style.textAlign = 'center';
                                td.style.color = '#6c757d';
                                td.textContent = 'Pendiente';
                            }
                            tr.appendChild(td);
                        }
                        pasteTableBody.appendChild(tr);
                    });
                });
            }

            // Resaltar celda activa y fila activa
            if (pasteTableBody) {
                pasteTableBody.addEventListener('focusin', function(e) {
                    if (e.target.tagName === 'TD') {
                        // Quitar resaltado previo
                        Array.from(pasteTableBody.rows).forEach(row => row.classList.remove('active-row'));
                        e.target.parentElement.classList.add('active-row');
                    }
                });
                
                pasteTableBody.addEventListener('focusout', function(e) {
                    if (e.target.tagName === 'TD') {
                        e.target.parentElement.classList.remove('active-row');
                    }
                });

                // Limpiar placeholder al enfocar
                pasteTableBody.addEventListener('focusin', function(e) {
                    if (e.target.classList.contains('placeholder')) {
                        e.target.classList.remove('placeholder');
                        e.target.textContent = '';
                    }
                });
            }

            // Tambi√©n despu√©s de pegar, si la tabla queda vac√≠a
            if (pasteTable) {
                pasteTable.addEventListener('paste', function() {
                    setTimeout(showPastePlaceholder, 100);
                });
            }

            // Mostrar placeholder al cargar
            setTimeout(showPastePlaceholder, 500);
        });

        // Limpiar tabla
        function clearPasteTable() {
            if (pasteTableBody) {
                pasteTableBody.innerHTML = '<tr><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 150px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 120px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 120px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 80px;"></td><td contenteditable="true" style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 80px;"></td><td style="padding: 1rem 0.75rem; border-bottom: 1px solid #dee2e6; min-width: 100px; text-align: center; color: #6c757d;">Pendiente</td></tr>';
                if (importStatus) {
                    importStatus.style.display = 'none';
                }
            }
        }

        // Validar y cargar datos a Firebase
        async function importPasteTable() {
            if (!pasteTableBody || !importStatus) {
                alert('Error: Elementos de la tabla no encontrados');
                return;
            }

            // Verificar que Firebase est√© disponible
            if (!window.firebaseDB || !window.firebaseDB.votesCollection) {
                alert('Error: Firebase no est√° disponible. Intenta recargar la p√°gina.');
                return;
            }

            importStatus.style.display = 'block';
            importStatus.className = 'import-status info';
            importStatus.textContent = 'Validando y cargando datos...';
            
            let count = 0, errors = 0;
            
            for (let tr of pasteTableBody.rows) {
                const [ubch, community, name, cedula, telefono, sexo, edad] = Array.from(tr.cells).map(td => td.textContent.trim());
                
                // Validaci√≥n b√°sica (tel√©fono es opcional)
                if (!ubch || !community || !name || !cedula || !sexo || !edad) {
                    errors++;
                    tr.style.background = '#fff3cd';
                    continue;
                }
                if (!/^\d{6,10}$/.test(cedula)) {
                    errors++;
                    tr.style.background = '#fff3cd';
                    continue;
                }
                // Validar tel√©fono solo si est√° presente (es opcional)
                if (telefono && !/^04\d{9}$/.test(telefono)) {
                    errors++;
                    tr.style.background = '#fff3cd';
                    continue;
                }
                if (!['M','F','m','f'].includes(sexo)) {
                    errors++;
                    tr.style.background = '#fff3cd';
                    continue;
                }
                if (isNaN(edad) || edad < 16 || edad > 120) {
                    errors++;
                    tr.style.background = '#fff3cd';
                    continue;
                }
                
                // Preparar datos
                const data = {
                    ubch,
                    community,
                    name,
                    cedula: cedula.replace(/\D/g, ''),
                    telefono: telefono ? telefono.replace(/\D/g, '') : '', // Tel√©fono opcional
                    sexo: sexo.toUpperCase(),
                    edad: parseInt(edad),
                    registeredBy: normalizarUsuario(JSON.parse(localStorage.getItem('currentUser')||'{}').username || 'admin'),
                    voted: false,
                    registeredAt: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                
                try {
                    // Verificar duplicados por c√©dula
                    const existing = await window.firebaseDB.votesCollection.where('cedula','==',data.cedula).get();
                    if (!existing.empty) {
                        tr.style.background = '#ffeaa7'; // Amarillo: duplicado
                        continue;
                    }
                    
                    await window.firebaseDB.votesCollection.add(data);
                    tr.style.background = '#d4edda'; // Verde: √©xito
                    count++;
                    
                    // Guardar tambi√©n en registros locales
                    if (typeof guardarRegistroLocal === 'function') {
                        guardarRegistroLocal({
                            nombre: data.name,
                            cedula: data.cedula,
                            telefono: data.telefono,
                            sexo: data.sexo,
                            edad: data.edad,
                            ubch: data.ubch,
                            comunidad: data.community,
                            fecha: new Date().toLocaleString()
                        });
                    }
                } catch (err) {
                    tr.style.background = '#f8d7da'; // Rojo: error
                    errors++;
                }
            }
            
            if (count > 0 && errors === 0) {
                importStatus.className = 'import-status success';
                importStatus.textContent = `‚úÖ ${count} registros cargados exitosamente.`;
            } else if (count > 0 && errors > 0) {
                importStatus.className = 'import-status warning';
                importStatus.textContent = `‚ö†Ô∏è ${count} registros cargados. ${errors} filas con errores o duplicados.`;
            } else {
                importStatus.className = 'import-status error';
                importStatus.textContent = `‚ùå No se cargaron registros. Verifica los datos.`;
            }
        }

        // Sugerencia visual en la primera celda si la tabla est√° vac√≠a
        function showPastePlaceholder() {
            if (pasteTableBody && pasteTableBody.rows.length === 1) {
                const firstRow = pasteTableBody.rows[0];
                let empty = true;
                for (let td of firstRow.cells) {
                    if (td.textContent.trim() !== '') empty = false;
                }
                if (empty) {
                    firstRow.cells[0].classList.add('placeholder');
                    firstRow.cells[0].textContent = 'Haz clic aqu√≠ y pega los datos de Excel';
                }
            }
        }
        
        // Tambi√©n despu√©s de limpiar la tabla
        const oldClearPasteTable = clearPasteTable;
        clearPasteTable = function() {
            oldClearPasteTable();
            setTimeout(showPastePlaceholder, 100);
        };

        // Funci√≥n para limpiar la cola y forzar sincronizaci√≥n
        async function limpiarColaYForzarSync() {
            if (window.offlineQueueManager) {
                // Limpiar cola local
                window.offlineQueueManager.limpiarColaLocal();
                
                // Forzar sincronizaci√≥n
                await window.offlineQueueManager.forzarSincronizacion();
                
                alert('‚úÖ Cola limpiada y sincronizaci√≥n forzada');
                } else {
                alert('‚ùå Gestor de cola no disponible');
                }
        }

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Verificar que estemos en HTTPS o localhost
                if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(function(registration) {
                            console.log('‚úÖ Service Worker registrado exitosamente:', registration.scope);
                            console.log('üì± PWA Status:', {
                                scope: registration.scope,
                                active: registration.active,
                                installing: registration.installing,
                                waiting: registration.waiting
                            });
                            
                            // Verificar si la p√°gina est√° controlada por el SW
                            if (navigator.serviceWorker.controller) {
                                console.log('‚úÖ P√°gina controlada por Service Worker');
                            } else {
                                console.log('‚ö†Ô∏è P√°gina no controlada por Service Worker');
                            }
                        })
                        .catch(function(error) {
                            console.error('‚ùå Error registrando Service Worker:', error);
                        });
                } else {
                    console.log('‚ö†Ô∏è Service Worker no registrado: Protocolo no soportado (requiere HTTPS o localhost)');
                }
            });
        } else {
            console.log('‚ùå Service Worker no soportado en este navegador');
        }

        // Funci√≥n f√°cil para mostrar 'Mis Registros' consultando solo los registros del usuario actual desde Firebase
        async function renderMyRecordsTable() {
            const tableBody = document.querySelector('#myrecords-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="8">Cargando...</td></tr>';

            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const username = normalizarUsuario(currentUser.username || '');
                if (!username) {
                    tableBody.innerHTML = '<tr><td colspan="8">No hay usuario activo</td></tr>';
                    return;
                }
                
                // Cargar datos desde Firebase (igual que en admin-panel)
                const snapshot = await window.firebaseDB.votesCollection.where('registeredBy', '==', username).get();
                const allUsers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Filtrar por el usuario actual
                const misRegistros = allUsers.filter(user => 
                    (user.registeredBy || '').trim().toLowerCase() === username
                );
                
                if (misRegistros.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8">No tienes registros propios a√∫n.</td></tr>';
                    return;
                }
                
                // Renderizar tabla
                let rows = '';
                misRegistros.forEach(d => {
                    rows += `<tr>
                        <td>${d.name || ''}</td>
                        <td>${d.cedula || ''}</td>
                        <td>${d.telefono || ''}</td>
                        <td>${d.sexo || ''}</td>
                        <td>${d.edad || ''}</td>
                        <td>${d.ubch || ''}</td>
                        <td>${d.community || ''}</td>
                        <td>${d.registeredAt ? (new Date(d.registeredAt)).toLocaleString('es-VE', {hour12:true}) : ''}</td>
                    </tr>`;
                });
                tableBody.innerHTML = rows;
                
                console.log(`‚úÖ Mis Registros: ${misRegistros.length} registros encontrados para ${username}`);
                
            } catch (error) {
                console.error('‚ùå Error cargando Mis Registros:', error);
                tableBody.innerHTML = '<tr><td colspan="8">Error cargando registros</td></tr>';
            }
        };

        // === FUNCI√ìN DE PRUEBA: Insertar registros de prueba para el usuario actual ===
        function insertarRegistrosDePrueba() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const username = normalizarUsuario(currentUser.username || '');
            if (!username) {
                alert('No hay usuario activo');
                return;
            }
            
            console.log('üß™ Insertando registros de prueba para:', username);
            
            // Crear 2 registros de prueba para Firebase
            if (window.firebaseDB && window.firebaseDB.votesCollection) {
                for (let i = 1; i <= 2; i++) {
                    const data = {
                        name: `Prueba Firebase ${i}`,
                        cedula: `9000000${i}`,
                        telefono: `0412000000${i}`,
                        sexo: i % 2 === 0 ? 'F' : 'M',
                        edad: 20 + i,
                        ubch: 'UBCH PRUEBA',
                        community: 'Comunidad Prueba',
                        registeredBy: username,
                        voted: false,
                        registeredAt: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    window.firebaseDB.votesCollection.add(data);
                }
            }
            
            // Crear 2 registros de prueba en la cola local
            if (window.offlineQueueManager && typeof window.offlineQueueManager.guardarEnColaLocal === 'function') {
                for (let i = 1; i <= 2; i++) {
                    const data = {
                        name: `Prueba Local ${i}`,
                        cedula: `8000000${i}`,
                        telefono: `0412000000${i}`,
                        sexo: i % 2 === 0 ? 'F' : 'M',
                        edad: 30 + i,
                        ubch: 'UBCH LOCAL',
                        community: 'Comunidad Local',
                        registeredBy: username,
                        voted: false,
                        registeredAt: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    };
                    window.offlineQueueManager.guardarEnColaLocal(data);
                }
            }
            
            // Crear 2 registros de prueba directamente en localStorage
            const registrosLocales = JSON.parse(localStorage.getItem('misRegistrosLocales') || '[]');
            for (let i = 1; i <= 2; i++) {
                registrosLocales.push({
                    nombre: `Prueba Local Direct ${i}`,
                    cedula: `7000000${i}`,
                    telefono: `0412000000${i}`,
                    sexo: i % 2 === 0 ? 'F' : 'M',
                    edad: 40 + i,
                    ubch: 'UBCH DIRECTO',
                    comunidad: 'Comunidad Directa',
                    fecha: new Date().toLocaleString()
                });
            }
            localStorage.setItem('misRegistrosLocales', JSON.stringify(registrosLocales));
            
            alert('‚úÖ Registros de prueba insertados. Revisa "Mis Registros".');
            
            // Refrescar la vista
            setTimeout(() => {
                if (window.renderMyRecordsTable) window.renderMyRecordsTable();
                if (window.renderMisRegistrosComoTarjetas) renderMisRegistrosComoTarjetas();
            }, 1000);
        }

        // Eliminar la creaci√≥n de los botones de prueba y migraci√≥n en la secci√≥n 'Mis Registros'
        // Solo dejar los botones principales
        document.addEventListener('DOMContentLoaded', function() {
            const myRecordsActions = document.querySelector('.myrecords-actions');
            if (myRecordsActions) {
                // Eliminar todos los botones excepto los dos principales
                const allowed = ['Descargar como Excel', 'Ver Mis Registros'];
                Array.from(myRecordsActions.querySelectorAll('button')).forEach(btn => {
                    if (!allowed.includes(btn.textContent.trim())) {
                        btn.remove();
                    }
                });
            }
        });



        // === FUNCI√ìN PARA LIMPIAR LA COLA LOCAL ===
        function limpiarMisRegistrosLocales() {
            if (window.offlineQueueManager && typeof window.offlineQueueManager.limpiarColaLocal === 'function') {
                if (confirm('¬øSeguro que quieres borrar todos tus registros locales?')) {
                    window.offlineQueueManager.limpiarColaLocal();
                    alert('Registros locales eliminados');
                }
            } else {
                alert('No se puede limpiar la cola local.');
            }
        }

        // Definir switchRegistrationMode globalmente para evitar errores de referencia
        window.switchRegistrationMode = function(mode) {
            const individualDiv = document.getElementById('individual-registration');
            const bulkDiv = document.getElementById('bulk-registration');
            const modeButtons = document.querySelectorAll('.mode-btn');
            
            // Verificar que los elementos existen antes de usarlos
            if (!individualDiv || !bulkDiv) {
                console.error('‚ùå Error: Elementos de registro no encontrados');
                return;
            }
            
            // Actualizar botones
            modeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            // Mostrar/ocultar secciones
            if (mode === 'individual') {
                individualDiv.style.display = 'block';
                bulkDiv.style.display = 'none';
            } else if (mode === 'bulk') {
                individualDiv.style.display = 'none';
                bulkDiv.style.display = 'block';
            }
            console.log(`‚úÖ Modo de registro cambiado a: ${mode}`);
        };

        // === FUNCI√ìN PARA LIMPIAR TODO (local y Firebase) ===
        // (Eliminada por seguridad y limpieza de interfaz)
        // ... existing code ...
        // Eliminar el bot√≥n de limpieza total si existe
        document.addEventListener('DOMContentLoaded', function() {
            const myRecordsActions = document.querySelector('.myrecords-actions');
            if (myRecordsActions) {
                Array.from(myRecordsActions.querySelectorAll('button')).forEach(btn => {
                    if (btn.textContent.trim() === 'Limpiar TODO (local y Firebase)') {
                        btn.remove();
                    }
                });
            }
        });

        // Funci√≥n para cargar configuraci√≥n UBCH
        async function loadUBCHConfig() {
            if (window.firebaseDB && window.firebaseDB.ubchCollection) {
                try {
                    const configDoc = await window.firebaseDB.ubchCollection.doc('config').get();
                    if (configDoc.exists && configDoc.data().mapping) {
                        mapping = configDoc.data().mapping;
                        console.log('‚úÖ Mapeo de CV/comunidades cargado desde Firebase (ubchCollection.config.mapping)');
                    }
                } catch (error) {
                    console.error('‚ùå Error cargando configuraci√≥n UBCH:', error);
                }
            }
        }
        
        // Cargar configuraci√≥n UBCH cuando est√© disponible
        if (window.firebaseDB && window.firebaseDB.ubchCollection) {
            loadUBCHConfig();
        }

        // === INICIALIZACI√ìN UNIFICADA DEL SISTEMA ===
        
        // Funci√≥n para inicializar el sistema de registro de manera unificada
        async function initializeRegistrationSystem() {
            console.log('üöÄ Inicializando sistema de registro unificado...');
            
            try {
                // 1. Verificar que Firebase est√© disponible
                if (!window.firebaseDB) {
                    console.error('‚ùå Firebase no est√° disponible');
                    throw new Error('Firebase no est√° configurado');
                }
                
                // 2. Crear instancia del sistema de votos si no existe
                if (!window.votingSystem) {
                    console.log('üìã Creando instancia del sistema de votos...');
                    window.votingSystem = new VotingSystemFirebase();
                    await window.votingSystem.init();
                }
                
                // 3. Configurar event listeners del formulario de registro
                const registrationForm = document.getElementById('registration-form');
                if (registrationForm) {
                    // Remover event listeners existentes para evitar duplicados
                    const newForm = registrationForm.cloneNode(true);
                    registrationForm.parentNode.replaceChild(newForm, registrationForm);
                    
                    // Agregar event listener para el env√≠o del formulario
                    newForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log('üìù Enviando formulario de registro...');
                        
                        if (window.votingSystem && typeof window.votingSystem.handleRegistration === 'function') {
                            await window.votingSystem.handleRegistration();
                        } else {
                            console.error('‚ùå Sistema de votos no disponible');
                            alert('Error: Sistema no disponible. Recarga la p√°gina.');
                        }
                    });
                    
                    console.log('‚úÖ Event listeners del formulario configurados');
                }
                
                // 4. Configurar event listeners para los selects
                const ubchSelect = document.getElementById('ubch');
                const communitySelect = document.getElementById('community');
                
                if (ubchSelect && communitySelect) {
                    // Event listener para cuando cambie el CV
                    ubchSelect.addEventListener('change', function() {
                        console.log('üîÑ CV seleccionado:', this.value);
                        // Los selects son independientes, no necesitan vinculaci√≥n
                    });
                    
                    // Event listener para cuando cambie la comunidad
                    communitySelect.addEventListener('change', function() {
                        console.log('üîÑ Comunidad seleccionada:', this.value);
                    });
                    
                    console.log('‚úÖ Event listeners de selects configurados');
                }
                
                // 5. Cargar datos iniciales
                if (window.votingSystem) {
                    await window.votingSystem.loadDataFromFirebase();
                    window.votingSystem.renderRegistrationPage();
                }
                
                console.log('‚úÖ Sistema de registro inicializado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando sistema de registro:', error);
                alert('Error al inicializar el sistema. Recarga la p√°gina.');
            }
        }
        
        // Funci√≥n para verificar y corregir problemas de inicializaci√≥n
        function checkAndFixInitialization() {
            console.log('üîç Verificando estado de inicializaci√≥n...');
            
            // Verificar que el formulario existe
            const form = document.getElementById('registration-form');
            if (!form) {
                console.error('‚ùå Formulario de registro no encontrado');
                return false;
            }
            
            // Verificar que los selects existen
            const ubchSelect = document.getElementById('ubch');
            const communitySelect = document.getElementById('community');
            if (!ubchSelect || !communitySelect) {
                console.error('‚ùå Selects de CV o comunidad no encontrados');
                return false;
            }
            
            // Verificar que el sistema de votos est√© disponible
            if (!window.votingSystem) {
                console.error('‚ùå Sistema de votos no inicializado');
                return false;
            }
            
            console.log('‚úÖ Verificaci√≥n de inicializaci√≥n exitosa');
            return true;
        }
        
        // === INICIALIZACI√ìN UNIFICADA AL CARGAR LA P√ÅGINA ===
        
        // Inicializar el sistema cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üì± P√°gina cargada, iniciando sistema unificado...');
            
            // Esperar a que Firebase est√© disponible
            let retries = 0;
            const maxRetries = 10;
            
            while (!window.firebaseDB && retries < maxRetries) {
                console.log(`‚è≥ Esperando Firebase... (intento ${retries + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, 1000));
                retries++;
            }
            
            if (!window.firebaseDB) {
                console.error('‚ùå Firebase no disponible despu√©s de m√∫ltiples intentos');
                alert('Error: No se pudo conectar con Firebase. Recarga la p√°gina.');
                return;
            }
            
            // Inicializar sistema de registro unificado
            await initializeRegistrationSystem();
            
            // Verificar que todo est√© funcionando correctamente
            if (!checkAndFixInitialization()) {
                console.error('‚ùå Problemas detectados en la inicializaci√≥n');
                alert('Error: Problemas detectados en la inicializaci√≥n. Recarga la p√°gina.');
                return;
            }
            
            console.log('üéâ Sistema unificado inicializado completamente');
            
            // Mostrar mensaje de √©xito
            const messageDiv = document.getElementById('registration-message');
            if (messageDiv) {
                messageDiv.textContent = '‚úÖ Sistema listo para registrar personas';
                messageDiv.className = 'message success';
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        });
        
        // Funci√≥n global para reinicializar el sistema si es necesario
        window.reinitializeSystem = async function() {
            console.log('üîÑ Reinicializando sistema...');
            await initializeRegistrationSystem();
        };
        
        // Funci√≥n global para verificar el estado del sistema
        window.checkSystemStatus = function() {
            return checkAndFixInitialization();
        };

        // Funci√≥n para verificar estado PWA
        window.checkPWAStatus = function() {
            if (window.pwaInstaller) {
                return window.pwaInstaller.showPWAInfo();
            }
            return null;
        };

        // Mostrar informaci√≥n PWA en consola al cargar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.pwaInstaller) {
                    console.log('üì± Estado PWA:');
                    window.pwaInstaller.showPWAInfo();
                }
            }, 2000);
        });

        // Funci√≥n global para instalaci√≥n manual de PWA
        window.installPWA = function() {
            if (window.pwaInstaller) {
                window.pwaInstaller.installPWA();
            } else {
                console.log('‚ö†Ô∏è PWA Installer no disponible');
                alert('La instalaci√≥n PWA no est√° disponible en este momento.');
            }
        };

        // Funci√≥n para limpiar configuraci√≥n de comunidades (solo se ejecuta una vez)
        window.limpiarConfiguracionComunidades = async function() {
            // Verificar si ya se ejecut√≥
            if (localStorage.getItem('configuracionLimpia') === 'true') {
                console.log('‚úÖ Configuraci√≥n ya fue limpiada anteriormente');
                return;
            }

            try {
                console.log('üßπ Iniciando limpieza de configuraci√≥n...');
                
                // Esperar a que Firebase est√© disponible
                let intentos = 0;
                while (!window.firebaseDB && intentos < 10) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    intentos++;
                }
                
                if (!window.firebaseDB) {
                    console.log('‚ö†Ô∏è Firebase no disponible, saltando limpieza');
                    return;
                }
                
                // Configuraci√≥n corregida sin las comunidades problem√°ticas
                const configCorregida = {
                    "COLEGIO ASUNCION BELTRAN": ["EL VALLE", "VILLA OASIS", "VILLAS DEL CENTRO 1ERA ETAPA", "VILLAS DEL CENTRO 3ERA ETAPA B", "VILLAS DEL CENTRO 3ERA ETAPA C", "VILLAS DEL CENTRO IV ETAPA", "LA CAMACHERA", "CONSOLACI√ìN"],
                    "LICEO JOSE FELIX RIBAS": ["EL CUJINAL", "LAS MORAS", "VILLA ESPERANZA 200", "VILLAS DEL CENTRO 3ERA ETAPA A", "LOS PALOMARES", "EL LAGO", "CARABALI I Y II", "EL BANCO", "CARIAPRIMA I Y II", "CONSOLACI√ìN"],
                    "ESCUELA PRIMARIA BOLIVARIANA LA PRADERA": ["EL SAMAN", "GUAYABAL E", "PALOS GRANDES II", "PALOS GRANDES I", "TIERRAS DEL SOL", "LA CASTELLANA", "GARDENIAS I", "GARDENIAS II", "EL CERCADITO", "ALTAMIRA", "LA ENSENADA", "BUCARES", "GUAYABAL", "APAMATE", "EL REFUGIO", "LOS ROBLES", "ARAGUANEY", "CONSOLACI√ìN"],
                    "CASA COMUNAL JOSE TOMAS GALLARDO": ["JOSE TOMAS GALLARDO A", "JOSE TOMAS GALLARDO B", "ALI PRIMERA", "CONSOLACI√ìN"],
                    "ESCUELA 5 DE JULIO": ["10 DE AGOSTO", "CAMPO ALEGRE I", "CAMPO ALEGRE II", "5 DE JULIO", "CONSOLACI√ìN"],
                    "ESCUELA CECILIO ACOSTA": ["VOLUNTAD DE DIOS", "LAS MALVINAS", "BRISAS DEL LAGO", "MAISANTA", "INDIANA SUR", "LOS CASTORES", "CONSOLACI√ìN"],
                    "ESCUELA BASICA FE Y ALEGRIA": ["FE Y ALEGRIA", "CONSOLACI√ìN"],
                    "ESCUELA GRADUADA ANTONIO JOSE DE SUCRE": ["PALO NEGRO OESTE", "JESUS DE NAZARETH", "SECTOR BOLIVAR", "PALO NEGRO ESTE", "CONSOLACI√ìN"],
                    "CASA COMUNAL": ["LOS JABILLOS", "CONSOLACI√ìN"],
                    "UNIDAD EDUCATIVA MONSE√ëOR JOS√â JACINTO SOTO LAYA": ["PROLONGACION MIRANDA", "SANTA EDUVIGES II", "CONSOLACI√ìN"],
                    "BASE DE MISIONES LUISA CACERES DE ARISMENDI": ["4 DE DICIEMBRE", "23 DE ENERO", "19 DE ABRIL", "EL EREIGUE", "CONSOLACI√ìN"],
                    "ESCUELA ESTADAL ALEJO ZULOAGA": ["MANUELITA SAENZ", "PANAMERICANO", "CONSOLACI√ìN"],
                    "UNIDAD EDUCATIVA MONSE√ëOR MONTES DE OCA": ["REMATE", "CONSOLACI√ìN"],
                    "ESCUELA BASICA NACIONAL CONCENTRADA LA ESTACION": ["18 DE OCTUBRE", "CONSOLACI√ìN"],
                    "ESCUELA RECEPTORIA": ["CARMEN CENTRO", "CENTRO CENTRO", "CONSOLACI√ìN"],
                    "GRUPO ESCOLAR DR RAFAEL PEREZ": ["VIRGEN DEL CARMEN", "CONSOLACI√ìN"],
                    "LICEO ALFREDO PIETRI": ["LOS OJITOS", "LOS VENCEDORES", "CONSOLACI√ìN"],
                    "ESCUELA BOLIVARIANA ROMERO GARCIA": ["SAN BERNARDO", "LA CAPILLA", "LAS HACIENDAS", "CONSOLACI√ìN"],
                    "ESCUELA GRADUADA PEDRO GUAL": ["BOQUITA CENTRO", "INDIANA NORTE", "CONSOLACI√ìN"]
                };
                
                console.log('üîÑ Actualizando configuraci√≥n en Firebase...');
                
                // Actualizar configuraci√≥n en Firebase
                await window.firebaseDB.ubchCollection.doc('config').set({
                    mapping: configCorregida,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    version: '1.1',
                    cleaned: true,
                    cleanedAt: new Date().toISOString()
                });
                
                console.log('‚úÖ Configuraci√≥n actualizada en Firebase');
                console.log('‚úÖ Comunidades "BARRIO SOLIDARIO" y "COMUNIDAD FUTURO" eliminadas');
                
                // Marcar como limpiado para evitar ejecuciones futuras
                localStorage.setItem('configuracionLimpia', 'true');
                
                // Actualizar configuraci√≥n local si el sistema est√° disponible
                if (window.votingSystem) {
                    window.votingSystem.ubchToCommunityMap = configCorregida;
                    window.votingSystem.renderRegistrationPage();
                }
                
            } catch (error) {
                console.error('‚ùå Error limpiando configuraci√≥n:', error);
            }
        };

        // Funci√≥n de diagn√≥stico para identificar problemas de navegaci√≥n
        window.diagnoseNavigation = function() {
            console.log('üîç === DIAGN√ìSTICO DE NAVEGACI√ìN ===');
            
            // Verificar usuario actual
            const currentUser = window.votingSystem ? window.votingSystem.getCurrentUser() : null;
            console.log('üë§ Usuario actual:', currentUser);
            
            // Verificar botones de navegaci√≥n
            const navButtons = document.querySelectorAll('.nav-btn');
            console.log('üîç Total de botones encontrados:', navButtons.length);
            
            navButtons.forEach(btn => {
                const isVisible = btn.style.display !== 'none';
                const isActive = btn.classList.contains('active');
                const hasClickListener = btn.onclick !== null;
                console.log(`üìã "${btn.textContent.trim()}" (${btn.id}): Visible=${isVisible}, Activo=${isActive}, ClickListener=${hasClickListener}`);
            });
            
            // Verificar p√°ginas
            const pages = ['verifier-dashboard-page', 'registrator-dashboard-page', 'verifier-history-page', 'registrator-history-page'];
            pages.forEach(pageId => {
                const page = document.getElementById(pageId);
                console.log(`üìÑ ${pageId}: ${page ? 'EXISTE' : 'NO EXISTE'}`);
            });
            
            // Verificar event listeners
            const dashboardBtn = document.getElementById('nav-verifier-dashboard');
            if (dashboardBtn) {
                console.log('üîç Event listeners del bot√≥n dashboard:', dashboardBtn.onclick);
                console.log('üîç Dataset del bot√≥n:', dashboardBtn.dataset);
            }
            
            console.log('üîç === FIN DIAGN√ìSTICO ===');
        };
        
        // Funci√≥n para forzar navegaci√≥n a dashboard
        window.forceDashboard = function() {
            console.log('üîÑ Forzando navegaci√≥n a dashboard...');
            if (window.votingSystem) {
                const currentUser = window.votingSystem.getCurrentUser();
                if (currentUser && currentUser.rol === 'verificador') {
                    window.votingSystem.navigateToPage('verifier-dashboard');
                } else if (currentUser && currentUser.rol === 'registrador') {
                    window.votingSystem.navigateToPage('registrator-dashboard');
                }
            }
        };
        
        // Funci√≥n para forzar configuraci√≥n de botones de dashboard
        window.forceSetupDashboardButtons = function() {
            console.log('üîß Forzando configuraci√≥n de botones de dashboard...');
            if (window.votingSystem) {
                window.votingSystem.forceSetupDashboardButtons();
            }
        };
    </script>
    

    
    <!-- Contenedor de Notificaciones -->
    <div id="notification-container"></div>
</body>
</html>