<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Votos 2025</title>
    <link rel="manifest" href="favicon.ico/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="favicon.ico/apple-icon-180x180.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.ico/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon.ico/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.ico/apple-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon.ico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon.ico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon.ico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon.ico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon.ico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon.ico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon.ico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="favicon.ico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" href="favicon.ico/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="favicon.ico/apple-icon-precomposed.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="favicon.ico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="144x144" href="favicon.ico/android-icon-144x144.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon.ico/android-icon-96x96.png">
    <link rel="icon" type="image/png" sizes="72x72" href="favicon.ico/android-icon-72x72.png">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon.ico/android-icon-48x48.png">
    <link rel="icon" type="image/png" sizes="36x36" href="favicon.ico/android-icon-36x36.png">
    
    <!-- Microsoft Icons -->
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="favicon.ico/ms-icon-144x144.png">
    <meta name="msapplication-config" content="favicon.ico/browserconfig.xml">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Libraries (cargar antes que otros scripts) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    
    <script src="config.js"></script>
    <script src="auto-init.js"></script>
    <script src="test-automatico.js"></script>
    <script src="test-proyeccion.js"></script>
    <script src="queue-manager.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-top">
                    <div class="logo-container">
                        <img src="logo.jpg" alt="Logo Sistema de Votos" class="header-logo">
                    </div>
                    <h1 class="header-title">Registro de Votos y Estad√≠sticas</h1>
                </div>
                <nav class="nav-menu">
                    <button class="nav-btn active" data-page="registration">Registro</button>
                    <button class="nav-btn" data-page="check-in">Confirmar Voto</button>
                    <button class="nav-btn" data-page="listado">Listado</button>
                    <button class="nav-btn" data-page="dashboard">Totales</button>
                    <button class="nav-btn" data-page="statistics">Estad√≠sticas</button>
                    <button class="nav-btn" data-page="user-registrations" id="nav-user-registrations" style="display: none;">Mis Registros</button>
                </nav>
                <div class="user-info">
                    <span class="user-id" id="userId"></span>
                    <div class="sync-status">
                        <span class="sync-spinner" id="sync-spinner"></span>
                        <span class="sync-check" id="sync-check"></span>
                        <span class="sync-indicator" id="sync-indicator">üîÑ</span>
                        <span class="sync-text" id="sync-text">Sincronizando</span>
                    </div>
                </div>
                <!-- Men√∫ desplegable m√≥vil -->
                <div class="mobile-menu">
                    <button class="menu-toggle" onclick="toggleMenu()">‚ãÆ</button>
                    <div class="menu-dropdown" id="menu-dropdown">
                        <!-- El contenido del men√∫ se generar√° din√°micamente por JS seg√∫n el rol -->
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Registration Page -->
            <div class="page active" id="registration-page">
                <div class="page-container">
                    <h2 class="page-title">Registro de Persona</h2>
                    
                    <!-- Selector de modo de registro -->
                    <div class="registration-mode-selector">
                        <button type="button" class="mode-btn active" data-mode="individual" onclick="switchRegistrationMode('individual')">
                            üë§ Registro Individual
                        </button>
                        <button type="button" class="mode-btn" data-mode="bulk" onclick="switchRegistrationMode('bulk')">
                            üìä Registro Masivo (Excel)
                        </button>
                    </div>
                    
                    <!-- Formulario de registro individual ORIGINAL (ahora visible y √∫nico) -->
                    <div id="individual-registration" class="registration-mode">
                        <form id="registration-form" class="registration-form" autocomplete="off">
                            <div class="form-group">
                                <label for="name">Nombre de la Persona</label>
                                <input type="text" id="name" name="name" placeholder="Ej: Juan P√©rez" required autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="cedula">C√©dula</label>
                                <input type="text" id="cedula" name="cedula" placeholder="Ej: 12345678" required title="Introduce una c√©dula v√°lida (solo n√∫meros, 6 a 10 d√≠gitos)" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="telefono">Tel√©fono (Opcional)</label>
                                <input type="text" id="telefono" name="telefono" placeholder="Ej: 04121234567" title="Introduce un tel√©fono v√°lido (ej: 04121234567)" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="sexo">Sexo</label>
                                <select id="sexo" name="sexo" required>
                                    <option value="">Selecciona el sexo</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edad">Edad</label>
                                <input type="number" id="edad" name="edad" placeholder="Ej: 25" min="16" max="120" required title="Introduce una edad v√°lida (entre 16 y 120 a√±os)" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label for="community">Comunidad de Residencia</label>
                                <select id="community" name="community" required></select>
                            </div>
                            <div class="form-group">
                                <label for="ubch">Centro de Votaci√≥n</label>
                                <select id="ubch" name="ubch" required></select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-large" id="register-btn">
                                <span class="btn-text">Registrar Persona</span>
                                <span class="btn-loading" style="display: none;">Registrando...</span>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Registro masivo desde Excel -->
                    <div id="bulk-registration" class="registration-mode" style="display: none;">
                        <div class="bulk-import-section">
                            <div class="import-info">
                                <h4>üìä Registro Masivo Copiando y Pegando desde Excel</h4>
                                <p>Copia las columnas desde tu archivo Excel (Ctrl+C) y p√©galas (Ctrl+V) directamente en la tabla de abajo. Aseg√∫rate de que el orden de las columnas sea: <strong>Nombre, C√©dula, Tel√©fono (opcional), Sexo (M/F), Edad, Comunidad, Centro de Votaci√≥n</strong>.</p>
                                <p>Puedes editar los datos directamente en la tabla antes de procesarlos.</p>
                            </div>
                            <div class="bulk-table-controls">
                                <button type="button" class="btn btn-info" onclick="addBulkRow()">‚ûï Agregar Fila</button>
                                <button type="button" class="btn btn-warning" onclick="removeSelectedBulkRows()">‚ûñ Eliminar Filas Seleccionadas</button>
                            </div>
                            <div class="table-responsive-bulk">
                                <table id="bulk-paste-table" class="bulk-paste-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-bulk-rows" onclick="toggleSelectAllBulkRows(this)"></th>
                                            <th>Nombre</th>
                                            <th>C√©dula</th>
                                            <th>Tel√©fono</th>
                                            <th>Sexo (M/F)</th>
                                            <th>Edad</th>
                                            <th>Comunidad</th>
                                            <th>Centro de Votaci√≥n</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulk-paste-table-body">
                                        <tr>
                                            <td><input type="checkbox" class="bulk-row-select"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td contenteditable="true"></td>
                                            <td></td> <!-- Celda para Estado, no editable por el usuario directamente -->
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <div id="bulk-processing-summary" class="bulk-import-summary" style="margin-top: 1rem; display: none;">
                                <p><strong>Resumen del Procesamiento:</strong> <span id="bulk-summary-text-processed"></span></p>
                            </div>
                            <div class="import-controls" style="margin-top: 1rem;">
                                <button type="button" class="btn btn-success btn-large" onclick="processPastedData()">‚öôÔ∏è Procesar Registros de Tabla</button>
                                <button type="button" class="btn btn-danger" onclick="clearBulkTable()">üóëÔ∏è Limpiar Tabla</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="registration-message" class="message" style="display: none;"></div>
                    <div id="queue-status" class="queue-status" style="display: none;"></div>
                    <div id="thank-you-message" class="thank-you-message" style="display: none;"></div>
                </div>
            </div>

            <!-- Check-in Page -->
            <div class="page" id="check-in-page">
                <div class="page-container">
                    <h2 class="page-title">Confirmar Voto</h2>
                    <form id="check-in-form" class="check-in-form">
                        <div class="search-container">
                            <input type="text" id="cedula-search" placeholder="Buscar por C√©dula" required>
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text">Buscar</span>
                                <span class="btn-loading" style="display: none;">Buscando...</span>
                            </button>
                        </div>
                    </form>
                    <div id="check-in-message" class="message" style="display: none;"></div>
                    <div id="search-results" class="search-results"></div>
                </div>
            </div>

            <!-- List Page -->
            <div class="page" id="listado-page">
                <div class="page-container">
                    <div class="page-header">
                        <h2 class="page-title">Listado de Personas Registradas</h2>
                        <div class="page-actions">
                            <button id="export-pdf-btn" class="btn btn-secondary">Generar PDF</button>
                            <button id="export-csv-btn" class="btn btn-secondary">Generar CSV</button>
                        </div>
                    </div>
                    <div class="filter-container">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">Todos</button>
                            <button class="filter-btn" data-filter="voted">Votaron</button>
                            <button class="filter-btn" data-filter="not-voted">No Votaron</button>
                            <span class="filter-counter" id="filter-counter">0</span>
                        </div>
                        <div class="ubch-filter">
                            <label for="ubch-filter-select">Filtrar por UBCH:</label>
                            <select id="ubch-filter-select" class="ubch-filter-select">
                                <option value="">Todas las UBCH</option>
                            </select>
                        </div>
                        <div class="community-filter">
                            <label for="community-filter-select">Filtrar por Comunidad:</label>
                            <select id="community-filter-select" class="community-filter-select">
                                <option value="">Todas las Comunidades</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="registros-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>C√©dula</th>
                                    <th>Sexo</th>
                                    <th>Edad</th>
                                    <th>UBCH</th>
                                    <th>Comunidad</th>
                                    <th>Vot√≥</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div id="pagination-controls" class="pagination-controls"></div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div class="page" id="dashboard-page">
                <div class="page-container">
                    <h2 class="page-title">Totales Generales</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total de Personas Registradas</h3>
                            <p class="stat-number" id="total-registered">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total de Votos Confirmados</h3>
                            <p class="stat-number" id="total-voted">0</p>
                        </div>
                    </div>
                    <div class="progress-section">
                        <h3>Progreso de Votaci√≥n</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="vote-progress"></div>
                        </div>
                        <p class="progress-text" id="progress-text">0 de 0 personas han votado.</p>
                    </div>
                </div>
            </div>

            <!-- Statistics Page -->
            <div class="page" id="statistics-page">
                <div class="page-container">
                    <div class="page-header">
                        <h2 class="page-title">Estad√≠sticas Detalladas</h2>
                        <div class="page-actions">
                            <button id="projection-btn" class="btn btn-primary">Modo Proyecci√≥n</button>
                            <button id="export-stats-pdf-btn" class="btn btn-secondary">Descargar PDF</button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stats-card">
                            <h3>Votos por UBCH</h3>
                            <div class="stats-list" id="ubch-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Comunidad</h3>
                            <div class="stats-list" id="community-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Sexo</h3>
                            <div class="stats-list" id="sexo-stats"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Votos por Rango de Edad</h3>
                            <div class="stats-list" id="edad-stats"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Registrations Page -->
            <div class="page" id="user-registrations-page" style="display: none;">
                <div class="page-container">
                    <div class="page-header">
                        <h2 class="page-title">Mis Registros Realizados</h2>
                        <div class="page-actions">
                            <button id="export-user-pdf-btn" class="btn btn-secondary">Generar PDF de Mis Registros</button>
                            <button id="export-user-csv-btn" class="btn btn-secondary">Generar CSV de Mis Registros</button>
                        </div>
                    </div>
                    <div class="filter-container">
                        <!-- Podr√≠an agregarse filtros espec√≠ficos para esta vista si es necesario en el futuro -->
                        <span class="filter-counter" id="user-filter-counter">0</span>
                    </div>
                    <div class="table-container">
                        <table id="user-registros-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>C√©dula</th>
                                    <th>Sexo</th>
                                    <th>Edad</th>
                                    <th>Centro de Votaci√≥n</th>
                                    <th>Comunidad</th>
                                    <th>Vot√≥</th>
                                    <th>Fecha Registro</th>
                                    <!-- No se incluye bot√≥n de eliminar/editar aqu√≠, es solo listado -->
                                </tr>
                            </thead>
                            <tbody id="user-registros-table-body"></tbody>
                        </table>
                        <div id="user-pagination-controls" class="pagination-controls"></div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Projection View -->
        <div id="projection-view" class="projection-view" style="display: none;">
            <div class="projection-header">
                <h1>Proyecci√≥n en Tiempo Real</h1>
                <button id="exit-projection-btn" class="btn btn-danger">Salir</button>
            </div>
            <div class="projection-content">
                <div class="projection-main">
                    <h2>Participaci√≥n General</h2>
                    <div class="projection-number" id="projection-votes">0</div>
                    <div class="projection-label">Votos</div>
                    <div class="projection-progress">
                        <div class="projection-progress-fill" id="projection-progress-fill"></div>
                    </div>
                    <p class="projection-text" id="projection-text">0 de 0</p>
                </div>
                <div class="projection-stats">
                    <h2>Votos por UBCH</h2>
                    <div class="projection-list" id="projection-ubch-list"></div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="delete-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Confirmar Eliminaci√≥n</h3>
                <p>¬øEst√°s seguro de que deseas eliminar este registro? Esta acci√≥n no se puede deshacer.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-delete">Cancelar</button>
                    <button class="btn btn-danger" id="confirm-delete">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Edici√≥n -->
        <div id="edit-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Editar Registro</h3>
                <form id="edit-form" class="edit-form">
                    <div class="form-group">
                        <label for="edit-ubch">UBCH</label>
                        <select id="edit-ubch" name="ubch" required>
                            <option value="">Selecciona una UBCH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-community">Comunidad</label>
                        <select id="edit-community" name="community" required disabled>
                            <option value="">Selecciona una comunidad</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-name">Nombre</label>
                        <input type="text" id="edit-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-cedula">C√©dula</label>
                        <input type="text" id="edit-cedula" name="cedula" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-telefono">Tel√©fono</label>
                        <input type="text" id="edit-telefono" name="telefono" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-sexo">Sexo</label>
                        <select id="edit-sexo" name="sexo" required>
                            <option value="">Selecciona el sexo</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-edad">Edad</label>
                        <input type="number" id="edit-edad" name="edad" min="16" max="120" required>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-edit">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="save-edit">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>¬© 2025 Registro de Votos y Estad√≠sticas. Todos los derechos reservados.</p>
        </footer>
    </div>

    
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="sync-manager.js"></script>
    <script src="service-manager.js"></script>
    <script src="script.js"></script>
    <script src="script-firebase.js"></script>
    <script src="init-system.js"></script>
    <script src="debug-ubch-filter.js"></script>
    <script src="test-filtro-ubch.js"></script>
    <script src="test-exportacion-mejorada.js"></script>
    
    <script>
        // ADVERTENCIA DE SEGURIDAD:
        // La constante USUARIOS_INICIALES ha sido eliminada de este archivo.
        // Las credenciales NUNCA deben estar hardcodeadas en el c√≥digo del cliente.
        // Implemente un sistema de autenticaci√≥n seguro (ej. Firebase Authentication)
        // y un mecanismo para crear usuarios administradores iniciales de forma segura
        // (ej. un script de setup del lado del servidor o una interfaz de superadministrador).
        // const USUARIOS_INICIALES = []; // Eliminada

        function showMessage(message, type = 'info') {
            const loginMessage = document.getElementById('login-message');
            loginMessage.textContent = message;
            loginMessage.className = `login-message ${type}`;
            loginMessage.style.display = 'block';
            if (type === 'success') {
                setTimeout(() => { loginMessage.style.display = 'none'; }, 3000);
            }
        }

        function renderLoginForm() {
            return `
                <div class="login-container">
                    <div class="login-header">
                        <img src="logo.jpg" alt="Logo Sistema de Votos">
                        <h1>Bienvenido</h1>
                        <p>Sistema de Registro de Votos 2025</p>
                    </div>
                    <div id="login-message" class="login-message" style="display:none;"></div>
                    <form id="login-form" class="login-form">
                        <div class="form-group">
                            <label for="username">Usuario</label>
                            <input type="text" id="username" name="username" placeholder="Ingresa tu usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contrase√±a</label>
                            <input type="password" id="password" name="password" placeholder="Ingresa tu contrase√±a" required>
                        </div>
                        <button type="submit" class="login-btn" id="login-btn">
                            <span class="btn-text">Iniciar Sesi√≥n</span>
                            <span class="btn-loading" style="display:none;"><div class="spinner"></div>Iniciando sesi√≥n...</span>
                        </button>
                    </form>
                </div>
            `;
        }

        function renderAppContent(user) {
            // Aqu√≠ puedes mostrar el contenido real de la app seg√∫n el rol
            // Ejemplo b√°sico:
            return `<div class="app-content">
                <h2>¬°Hola, ${user.username}!</h2>
                <p>Tu rol es: <strong>${user.rol}</strong></p>
                <button onclick="logout()">Cerrar Sesi√≥n</button>
                <!-- Aqu√≠ va el resto de la app -->
            </div>`;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sessionTime');
            window.location.href = 'login.html';
        }

        function checkSession() {
            const currentUser = localStorage.getItem('currentUser');
            const sessionTime = localStorage.getItem('sessionTime');
            
            if (!currentUser) {
                window.location.href = 'login.html';
                        return;
            }
            
            // Verificar si la sesi√≥n ha expirado (24 horas)
            if (sessionTime && (Date.now() - parseInt(sessionTime)) > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('sessionTime');
                window.location.href = 'login.html';
                return;
            }
            
            // Mostrar informaci√≥n del usuario
            try {
                const user = JSON.parse(currentUser);
                const userInfo = document.getElementById('userId');
                if (userInfo) {
                    userInfo.textContent = `${user.username} (${user.rol})`;
                }
            } catch (error) {
                console.error('Error al mostrar informaci√≥n del usuario:', error);
            }
        }

        // Sistema de inicializaci√≥n manejado por init-system.js

        // Variables para registro masivo
        let bulkRegistrations = [];
        let bulkFile = null;

        // --- Persistencia temporal del formulario y modo de registro ---
        function saveRegistrationDraft() {
            const mode = localStorage.getItem('registrationMode') || 'individual';
            const draft = { mode };
            if (mode === 'individual') {
                const form = document.getElementById('registration-form');
                if (form) {
                    draft.ubch = form.ubch ? form.ubch.value : '';
                    draft.community = form.community ? form.community.value : '';
                    draft.name = form.name ? form.name.value : '';
                    draft.cedula = form.cedula ? form.cedula.value : '';
                    draft.telefono = form.telefono ? form.telefono.value : '';
                    draft.sexo = form.sexo ? form.sexo.value : '';
                    draft.edad = form.edad ? form.edad.value : '';
                }
            }
            localStorage.setItem('registrationDraft', JSON.stringify(draft));
        }

        // Solo restaurar el draft una vez al cargar la p√°gina
        let registrationDraftRestored = false;
        function restoreRegistrationDraftOnce() {
            if (registrationDraftRestored) return;
            registrationDraftRestored = true;
            const draftStr = localStorage.getItem('registrationDraft');
            if (!draftStr) return;
            let draft;
            try {
                draft = JSON.parse(draftStr);
            } catch (e) { return; }
            if (draft.mode) {
                switchRegistrationMode(draft.mode);
            }
            if (draft.mode === 'individual') {
                const form = document.getElementById('registration-form');
                if (form) {
                    form._pendingDraft = draft;
                    setRegistrationDraftValues(form, draft);
                }
            }
        }

        function setRegistrationDraftValues(form, draft) {
            // Asigna los valores del borrador si existen las opciones
            if (form.ubch && draft.ubch) {
                form.ubch.value = draft.ubch;
            }
            if (form.community && draft.community) {
                form.community.value = draft.community;
            }
            if (form.name) form.name.value = draft.name || '';
            if (form.cedula) form.cedula.value = draft.cedula || '';
            if (form.telefono) form.telefono.value = draft.telefono || '';
            if (form.sexo) form.sexo.value = draft.sexo || '';
            if (form.edad) form.edad.value = draft.edad || '';
        }

        function clearRegistrationDraft() {
            localStorage.removeItem('registrationDraft');
        }

        // Elimina cualquier refresco autom√°tico de selects por eventos personalizados
        // (No volver a llamar a onUBCHAndCommunityLoaded ni restaurar draft por eventos)

        // Configurar el input de archivo para registro masivo
        document.addEventListener('DOMContentLoaded', function() {
            const bulkFileInput = document.getElementById('bulk-excel-input');
            if (bulkFileInput) {
                bulkFileInput.addEventListener('change', handleBulkFileSelect);
            }
            // Restaurar draft SOLO una vez al cargar la p√°gina
            setTimeout(restoreRegistrationDraftOnce, 200);
        });

        // Al enviar el formulario, guardar el draft actualizado y limpiar si es necesario
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registration-form');
            if (form) {
                form.addEventListener('submit', function() {
                    saveRegistrationDraft();
                    // Si quieres limpiar el draft tras registro exitoso, llama a clearRegistrationDraft() despu√©s del registro
                });
            }
        });

        // Funciones para registro masivo
        function switchRegistrationMode(mode) {
            const individualMode = document.getElementById('individual-registration');
            const bulkMode = document.getElementById('bulk-registration');
            const individualBtn = document.querySelector('[data-mode="individual"]');
            const bulkBtn = document.querySelector('[data-mode="bulk"]');

            if (mode === 'individual') {
                individualMode.style.display = 'block';
                bulkMode.style.display = 'none';
                individualBtn.classList.add('active');
                bulkBtn.classList.remove('active');
            } else {
                individualMode.style.display = 'none';
                bulkMode.style.display = 'block';
                bulkBtn.classList.add('active');
                individualBtn.classList.remove('active');
            }
            localStorage.setItem('registrationMode', mode);
            saveRegistrationDraft();
        }

        // Manejar selecci√≥n de archivo para registro masivo
        function handleBulkFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            bulkFile = file;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const registrations = parseBulkCSV(content);
                    
                    if (registrations.length === 0) {
                        showBulkStatus('‚ùå No se encontraron datos v√°lidos en el archivo', 'error');
                        return;
                    }

                    bulkRegistrations = registrations;
                    showBulkPreview(registrations);
                    showBulkStatus(`üìã ${registrations.length} registros encontrados para importar`, 'success');
                    
                } catch (error) {
                    showBulkStatus(`‚ùå Error procesando archivo: ${error.message}`, 'error');
                }
            };

            reader.readAsText(file);
        }

        // Parsear archivo CSV para registro masivo
        function parseBulkCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos');
            }

            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredHeaders = ['ubch', 'comunidad', 'nombre', 'c√©dula', 'tel√©fono', 'sexo', 'edad'];
            
            // Verificar que los encabezados sean correctos
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            if (missingHeaders.length > 0) {
                throw new Error(`Faltan columnas requeridas: ${missingHeaders.join(', ')}`);
            }

            const registrations = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length < 7) continue;

                const registration = {
                    ubch: values[headers.indexOf('ubch')],
                    comunidad: values[headers.indexOf('comunidad')],
                    nombre: values[headers.indexOf('nombre')],
                    cedula: values[headers.indexOf('c√©dula')],
                    telefono: values[headers.indexOf('tel√©fono')],
                    sexo: values[headers.indexOf('sexo')].toUpperCase(),
                    edad: parseInt(values[headers.indexOf('edad')])
                };

                // Validar datos
                if (!registration.nombre || !registration.cedula || !registration.telefono) {
                    continue; // Saltar filas incompletas
                }

                if (!['M', 'F'].includes(registration.sexo)) {
                    registration.sexo = 'M'; // Sexo por defecto si no es v√°lido
                }

                if (isNaN(registration.edad) || registration.edad < 16 || registration.edad > 120) {
                    registration.edad = 18; // Edad por defecto si no es v√°lida
                }

                registrations.push(registration);
            }

            return registrations;
        }

        // Mostrar vista previa de registro masivo
        function showBulkPreview(registrations) {
            const previewDiv = document.getElementById('bulk-import-preview');
            const contentDiv = document.getElementById('bulk-preview-content');
            const summaryDiv = document.getElementById('bulk-summary-text');
            
            if (!previewDiv || !contentDiv) return;

            let tableHTML = `
                <table class="bulk-preview-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>C√©dula</th>
                            <th>UBCH</th>
                            <th>Comunidad</th>
                            <th>Sexo</th>
                            <th>Edad</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let validCount = 0;
            let invalidCount = 0;

            registrations.forEach(registration => {
                const status = validateBulkRegistration(registration);
                const statusClass = status === '‚úÖ V√°lido' ? 'valid' : 'invalid';
                
                if (status === '‚úÖ V√°lido') {
                    validCount++;
                } else {
                    invalidCount++;
                }
                
                tableHTML += `
                    <tr>
                        <td>${registration.nombre}</td>
                        <td>${registration.cedula}</td>
                        <td>${registration.ubch}</td>
                        <td>${registration.comunidad}</td>
                        <td>${registration.sexo}</td>
                        <td>${registration.edad}</td>
                        <td class="bulk-status ${statusClass}">${status}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            contentDiv.innerHTML = tableHTML;
            
            if (summaryDiv) {
                summaryDiv.textContent = `${validCount} v√°lidos, ${invalidCount} con problemas`;
            }
            
            previewDiv.style.display = 'block';
        }

        // Validar registro individual
        function validateBulkRegistration(registration) {
            if (!registration.nombre || registration.nombre.length < 2) {
                return '‚ùå Nombre muy corto';
            }
            if (!registration.cedula || !/^\d{6,10}$/.test(registration.cedula)) {
                return '‚ùå C√©dula inv√°lida';
            }
            if (!registration.telefono || !/^\d{10,11}$/.test(registration.telefono)) {
                return '‚ùå Tel√©fono inv√°lido';
            }
            if (!['M', 'F'].includes(registration.sexo)) {
                return '‚ùå Sexo inv√°lido';
            }
            if (isNaN(registration.edad) || registration.edad < 16 || registration.edad > 120) {
                return '‚ùå Edad inv√°lida';
            }
            return '‚úÖ V√°lido';
        }

        // Mostrar estado de registro masivo
        function showBulkStatus(message, type) {
            const previewDiv = document.getElementById('bulk-import-preview');
            if (!previewDiv) return;

            const statusDiv = document.createElement('div');
            statusDiv.className = `bulk-status ${type}`;
            statusDiv.textContent = message;
            
            // Insertar al inicio del preview
            previewDiv.insertBefore(statusDiv, previewDiv.firstChild);
            
            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Confirmar registro masivo
        async function confirmBulkImport() {
            if (bulkRegistrations.length === 0) {
                showBulkStatus('‚ùå No hay registros para importar', 'error');
                return;
            }

            try {
                let importedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                for (const registration of bulkRegistrations) {
                    try {
                        // Verificar si ya existe un registro con esa c√©dula
                        const existingQuery = await window.firebaseDB.votesCollection
                            .where('cedula', '==', registration.cedula)
                            .get();

                        if (!existingQuery.empty) {
                            skippedCount++;
                            continue; // Saltar registro existente
                        }

                        // Crear nuevo registro
                        const newRegistration = {
                            ubch: registration.ubch,
                            comunidad: registration.comunidad,
                            nombre: registration.nombre,
                            cedula: registration.cedula,
                            telefono: registration.telefono,
                            sexo: registration.sexo,
                            edad: registration.edad,
                            voted: false,
                            createdAt: new Date().toISOString(),
                            createdBy: JSON.parse(localStorage.getItem('currentUser')).name || 'Sistema'
                        };

                        await window.firebaseDB.votesCollection.add(newRegistration);
                        importedCount++;

                        // Mostrar progreso cada 10 registros
                        if (importedCount % 10 === 0) {
                            showBulkStatus(`üìä Progreso: ${importedCount} registros importados...`, 'success');
                        }

                    } catch (error) {
                        console.error('Error importando registro:', error);
                        errorCount++;
                    }
                }

                // Mostrar resultados finales
                let resultMessage = `‚úÖ ${importedCount} registros importados exitosamente`;
                if (skippedCount > 0) {
                    resultMessage += `, ${skippedCount} registros existentes omitidos`;
                }
                if (errorCount > 0) {
                    resultMessage += `, ${errorCount} errores`;
                }
                
                showBulkStatus(resultMessage, 'success');
                
                // Actualizar contadores en la interfaz
                if (window.updateDashboard) {
                    window.updateDashboard();
                }
                if (window.loadRegistrations) {
                    window.loadRegistrations();
                }

                // Limpiar vista previa
                cancelBulkImport();

            } catch (error) {
                showBulkStatus(`‚ùå Error en importaci√≥n: ${error.message}`, 'error');
            }
        }

        // Cancelar registro masivo
        function cancelBulkImport() {
            bulkRegistrations = [];
            bulkFile = null;
            
            const previewDiv = document.getElementById('bulk-import-preview');
            const fileInput = document.getElementById('bulk-excel-input');
            
            if (previewDiv) {
                previewDiv.style.display = 'none';
            }
            if (fileInput) {
                fileInput.value = '';
            }
        }

        function downloadBulkTemplate() {
            const template = `UBCH,Comunidad,Nombre,C√©dula,Tel√©fono,Sexo,Edad
UBCH-001,Comunidad A,Juan P√©rez,12345678,04121234567,M,25
UBCH-002,Comunidad B,Mar√≠a Garc√≠a,87654321,04261234567,F,30
UBCH-003,Comunidad C,Carlos L√≥pez,11223344,04141234567,M,28`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla-registro-masivo.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Agregar funci√≥n de logout al men√∫ m√≥vil
        function setupMobileMenu() {
            const menuDropdown = document.getElementById('menu-dropdown');
            if (menuDropdown) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                let menuHTML = '';
                
                menuHTML += '<a href="admin-panel.html" class="menu-item"><span class="icon">‚öôÔ∏è</span>Panel de Administraci√≥n</a>';
                menuHTML += '<a href="#" onclick="logout()" class="menu-item danger"><span class="icon">üö™</span>Cerrar Sesi√≥n</a>';
                
                menuDropdown.innerHTML = menuHTML;
            }
        }

        // Configurar men√∫ m√≥vil
        document.addEventListener('DOMContentLoaded', function() {
            setupMobileMenu();
        });

        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registrado:', reg))
                    .catch(err => console.log('Error al registrar Service Worker:', err));
            });
        }

        // Bot√≥n Instalar como App
        let deferredPrompt;
        const installBtn = document.getElementById('install-app-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });
        installBtn && installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });
        // Ocultar si ya est√° instalada
        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
        });
        // --- Protecci√≥n de selects UBCH/Comunidad para evitar refrescos indeseados ---
        function protectSelectPersistence() {
            const form = document.getElementById('registration-form');
            if (!form) return;
            let lastUBCH = form.ubch ? form.ubch.value : '';
            let lastCommunity = form.community ? form.community.value : '';

            const ubchSelect = form.ubch;
            const communitySelect = form.community;
            if (ubchSelect) {
                const observer = new MutationObserver(() => {
                    if (lastUBCH && Array.from(ubchSelect.options).some(opt => opt.value === lastUBCH)) {
                        ubchSelect.value = lastUBCH;
                    }
                });
                observer.observe(ubchSelect, { childList: true });
                ubchSelect.addEventListener('change', () => {
                    lastUBCH = ubchSelect.value;
                    // Cuando cambia la UBCH, intentar restaurar comunidad si sigue siendo v√°lida
                    if (communitySelect) {
                        setTimeout(() => {
                            if (lastCommunity && Array.from(communitySelect.options).some(opt => opt.value === lastCommunity)) {
                                communitySelect.value = lastCommunity;
                            } else {
                                // Si la comunidad previa ya no existe, seleccionar la primera opci√≥n v√°lida
                                const firstValid = Array.from(communitySelect.options).find(opt => opt.value);
                                if (firstValid) communitySelect.value = firstValid.value;
                                lastCommunity = communitySelect.value;
                            }
                        }, 50);
                    }
                });
            }
            if (communitySelect) {
                const observer2 = new MutationObserver(() => {
                    if (lastCommunity && Array.from(communitySelect.options).some(opt => opt.value === lastCommunity)) {
                        communitySelect.value = lastCommunity;
                    } else {
                        // Si la comunidad previa ya no existe, seleccionar la primera opci√≥n v√°lida
                        const firstValid = Array.from(communitySelect.options).find(opt => opt.value);
                        if (firstValid) communitySelect.value = firstValid.value;
                        lastCommunity = communitySelect.value;
                    }
                });
                observer2.observe(communitySelect, { childList: true });
                communitySelect.addEventListener('change', () => {
                    lastCommunity = communitySelect.value;
                });
            }
        }
        document.addEventListener('DOMContentLoaded', protectSelectPersistence);
    </script>
</body>
</html>