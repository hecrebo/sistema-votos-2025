<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sincronizaci√≥n - Sistema de Votos 2025</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.delete { background-color: #dc3545; }
        button.delete:hover { background-color: #c82333; }
        #votes-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .vote-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .vote-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Sincronizaci√≥n en Tiempo Real</h1>
        <p>Esta p√°gina permite probar la sincronizaci√≥n de eliminaciones entre dispositivos.</p>
        
        <div class="test-section">
            <h3>Estado de Firebase</h3>
            <div id="firebase-status" class="status info">Verificando conexi√≥n...</div>
        </div>
        
        <div class="test-section">
            <h3>Acciones de Prueba</h3>
            <button onclick="addTestVote()">‚ûï Agregar Voto de Prueba</button>
            <button onclick="refreshVotes()">üîÑ Refrescar Lista</button>
            <button onclick="clearAllVotes()" class="delete">üóëÔ∏è Limpiar Todos</button>
    </div>
    
        <div class="test-section">
            <h3>Lista de Votos (Tiempo Real)</h3>
            <div id="votes-list">
                <p>Cargando votos...</p>
            </div>
    </div>
    
        <div class="test-section">
            <h3>Log de Eventos</h3>
            <div id="event-log" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                <p>Esperando eventos...</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Configuraci√≥n Firebase -->
    <script src="firebase-config.js"></script>
    
    <script>
        let votes = [];
        let eventLog = [];
        
        // Funci√≥n para agregar log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            eventLog.unshift(logEntry);
            
            // Mantener solo los √∫ltimos 50 logs
            if (eventLog.length > 50) {
                eventLog = eventLog.slice(0, 50);
            }
            
            const logElement = document.getElementById('event-log');
            logElement.innerHTML = eventLog.map(log => `<div>${log}</div>`).join('');
        }
        
        // Funci√≥n para actualizar estado de Firebase
        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            statusElement.className = `status ${status}`;
            statusElement.textContent = message;
        }
        
        // Funci√≥n para renderizar lista de votos
        function renderVotes() {
            const votesList = document.getElementById('votes-list');
            
            if (votes.length === 0) {
                votesList.innerHTML = '<p>No hay votos registrados</p>';
                return;
            }
            
            votesList.innerHTML = votes.map(vote => `
                <div class="vote-item">
                    <div>
                        <strong>${vote.name}</strong> - ${vote.cedula}
                        <br><small>${vote.ubch} - ${vote.community}</small>
                    </div>
                    <button onclick="deleteVote('${vote.id}')" class="delete">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        // Funci√≥n para agregar voto de prueba
        async function addTestVote() {
            try {
                const testVote = {
                    id: 'test_' + Date.now(),
                    name: 'Usuario de Prueba ' + Math.floor(Math.random() * 1000),
                    cedula: Math.floor(Math.random() * 90000000) + 10000000,
                    telefono: '04' + Math.floor(Math.random() * 90000000) + 10000000,
                    sexo: Math.random() > 0.5 ? 'M' : 'F',
                    edad: Math.floor(Math.random() * 50) + 18,
                    ubch: 'COLEGIO ASUNCION BELTRAN',
                    community: 'EL VALLE',
                    registeredAt: new Date().toISOString(),
                    registeredBy: 'test-user',
                    voted: false
                };
                
                if (window.firebaseDB && window.firebaseDB.firebaseSyncManager) {
                    await window.firebaseDB.firebaseSyncManager.saveVote(testVote);
                    addLog('‚úÖ Voto de prueba agregado a Firebase', 'success');
                } else {
                    votes.push(testVote);
                    localStorage.setItem('votesData', JSON.stringify(votes));
                    renderVotes();
                    addLog('‚úÖ Voto de prueba agregado localmente', 'success');
                }
            } catch (error) {
                addLog('‚ùå Error agregando voto de prueba: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n para eliminar voto
        async function deleteVote(voteId) {
            try {
                if (window.firebaseDB && window.firebaseDB.firebaseSyncManager) {
                    await window.firebaseDB.firebaseSyncManager.deleteVote(voteId);
                    addLog('üóëÔ∏è Voto eliminado de Firebase: ' + voteId, 'success');
                } else {
                    votes = votes.filter(v => v.id !== voteId);
                    localStorage.setItem('votesData', JSON.stringify(votes));
                    renderVotes();
                    addLog('üóëÔ∏è Voto eliminado localmente: ' + voteId, 'success');
                }
            } catch (error) {
                addLog('‚ùå Error eliminando voto: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n para refrescar votos
        async function refreshVotes() {
            try {
                if (window.firebaseDB && window.firebaseDB.firebaseSyncManager) {
                    votes = await window.firebaseDB.firebaseSyncManager.loadVotesFromFirebase();
                    addLog('üîÑ Votos refrescados desde Firebase: ' + votes.length + ' registros', 'info');
                } else {
                    const votesData = localStorage.getItem('votesData');
                    votes = votesData ? JSON.parse(votesData) : [];
                    addLog('üîÑ Votos refrescados desde localStorage: ' + votes.length + ' registros', 'info');
                }
                renderVotes();
            } catch (error) {
                addLog('‚ùå Error refrescando votos: ' + error.message, 'error');
            }
        }
        
        // Funci√≥n para limpiar todos los votos
        async function clearAllVotes() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los votos?')) {
                try {
                    if (window.firebaseDB && window.firebaseDB.firebaseSyncManager) {
                        // Eliminar todos los votos de Firebase
                        for (const vote of votes) {
                            await window.firebaseDB.firebaseSyncManager.deleteVote(vote.id);
                        }
                        addLog('üóëÔ∏è Todos los votos eliminados de Firebase', 'success');
                    } else {
                        votes = [];
                        localStorage.setItem('votesData', JSON.stringify(votes));
                        renderVotes();
                        addLog('üóëÔ∏è Todos los votos eliminados localmente', 'success');
                    }
            } catch (error) {
                    addLog('‚ùå Error limpiando votos: ' + error.message, 'error');
                }
            }
        }
        
        // Inicializaci√≥n
        async function init() {
            addLog('üöÄ Iniciando test de sincronizaci√≥n...', 'info');
            
            // Verificar Firebase
            if (window.firebaseDB && window.firebaseDB.firebaseSyncManager) {
                updateFirebaseStatus('success', '‚úÖ Firebase conectado y funcionando');
                addLog('‚úÖ Firebase detectado y configurado', 'success');
                
                // Configurar listeners en tiempo real
                window.addEventListener('votesDataUpdated', (event) => {
                    votes = event.detail.data;
                    renderVotes();
                    addLog('üîÑ Lista de votos actualizada en tiempo real: ' + votes.length + ' registros', 'info');
                });
                
                window.addEventListener('voteDeleted', (event) => {
                    addLog('üóëÔ∏è Voto eliminado en tiempo real: ' + event.detail.voteId, 'info');
                });
                
                // Cargar votos iniciales
                try {
                    votes = await window.firebaseDB.firebaseSyncManager.loadVotesFromFirebase();
                    addLog('üì• Votos cargados inicialmente: ' + votes.length + ' registros', 'success');
            } catch (error) {
                    addLog('‚ö†Ô∏è Error cargando votos iniciales: ' + error.message, 'error');
                }
                
            } else {
                updateFirebaseStatus('error', '‚ùå Firebase no disponible');
                addLog('‚ùå Firebase no detectado, usando modo local', 'error');
                
                // Cargar desde localStorage
                const votesData = localStorage.getItem('votesData');
                votes = votesData ? JSON.parse(votesData) : [];
                addLog('üì• Votos cargados desde localStorage: ' + votes.length + ' registros', 'info');
            }
            
            renderVotes();
            addLog('‚úÖ Test de sincronizaci√≥n iniciado correctamente', 'success');
        }
        
        // Iniciar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 