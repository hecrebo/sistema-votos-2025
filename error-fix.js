// error-fix.js
// Reparaci√≥n espec√≠fica para errores identificados en los logs

console.log('üîß Iniciando reparaci√≥n de errores espec√≠ficos...');

// Error 1: Firebase votesCollection undefined
function fixFirebaseCollectionError() {
    console.log('üî• Reparando error de Firebase votesCollection...');
    
    try {
        // Verificar si firebaseDB existe
        if (!window.firebaseDB) {
            console.log('‚ö†Ô∏è firebaseDB no disponible, creando configuraci√≥n de respaldo...');
            window.firebaseDB = {
                isAvailable: false,
                db: null,
                votesCollection: null,
                ubchCollection: null,
                defaultUBCHConfig: {
                    "COLEGIO ASUNCION BELTRAN": ["EL VALLE", "VILLA OASIS"],
                    "LICEO JOSE FELIX RIBAS": ["EL CUJIJAL", "LAS FLORES"]
                },
                initializeUBCHConfig: async function() {
                    console.log('‚úÖ Configuraci√≥n UBCH inicializada (modo offline)');
                }
            };
        }
        
        // Verificar si votesCollection existe
        if (!window.firebaseDB.votesCollection) {
            console.log('‚ö†Ô∏è votesCollection no disponible, creando mock...');
            window.firebaseDB.votesCollection = {
                get: async () => ({ docs: [] }),
                add: async (data) => ({ id: Date.now().toString() }),
                doc: (id) => ({
                    get: async () => ({ exists: false, data: () => null }),
                    set: async (data) => ({ id }),
                    update: async (data) => ({ id }),
                    delete: async () => ({ id })
                }),
                limit: (num) => ({
                    get: async () => ({ docs: [] })
                })
            };
        }
        
        console.log('‚úÖ Error de Firebase votesCollection reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando Firebase:', error);
    }
}

// Error 2: appendChild null error
function fixAppendChildError() {
    console.log('üìù Reparando error de appendChild...');
    
    try {
        // Verificar si el elemento existe antes de usar appendChild
        const originalAppendChild = Element.prototype.appendChild;
        Element.prototype.appendChild = function(child) {
            if (this && this.nodeType === Node.ELEMENT_NODE) {
                return originalAppendChild.call(this, child);
            } else {
                console.warn('‚ö†Ô∏è Intentando appendChild en elemento null/undefined');
                return null;
            }
        };
        
        console.log('‚úÖ Error de appendChild reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando appendChild:', error);
    }
}

// Error 3: style null error
function fixStyleError() {
    console.log('üé® Reparando error de style...');
    
    try {
        // Verificar si el elemento existe antes de acceder a style
        const originalStyle = Object.getOwnPropertyDescriptor(HTMLElement.prototype, 'style');
        Object.defineProperty(HTMLElement.prototype, 'style', {
            get: function() {
                if (this && this.nodeType === Node.ELEMENT_NODE) {
                    return originalStyle.get.call(this);
                } else {
                    console.warn('‚ö†Ô∏è Intentando acceder a style en elemento null/undefined');
                    return { display: 'none' };
                }
            },
            set: function(value) {
                if (this && this.nodeType === Node.ELEMENT_NODE) {
                    originalStyle.set.call(this, value);
                } else {
                    console.warn('‚ö†Ô∏è Intentando establecer style en elemento null/undefined');
                }
            }
        });
        
        console.log('‚úÖ Error de style reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando style:', error);
    }
}

// Error 4: Service Worker registration
function fixServiceWorkerError() {
    console.log('üîß Reparando error de Service Worker...');
    
    try {
        // Verificar si el Service Worker est√° disponible
        if ('serviceWorker' in navigator) {
            // Registrar Service Worker con manejo de errores
            navigator.serviceWorker.register('./service-worker.js')
                .then(function(registration) {
                    console.log('‚úÖ Service Worker registrado exitosamente:', registration);
                })
                .catch(function(error) {
                    console.warn('‚ö†Ô∏è Error registrando Service Worker (no cr√≠tico):', error);
                });
        } else {
            console.log('‚ÑπÔ∏è Service Worker no disponible en este navegador');
        }
        
        console.log('‚úÖ Error de Service Worker reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando Service Worker:', error);
    }
}

// Reparar funci√≥n switchRegistrationMode
function fixSwitchRegistrationMode() {
    console.log('üîÑ Reparando funci√≥n switchRegistrationMode...');
    
    try {
        // Redefinir la funci√≥n con manejo de errores
        window.switchRegistrationMode = function(mode) {
            try {
                console.log(`üîÑ Cambiando modo de registro a: ${mode}`);
                
                // Ocultar todos los modos
                const modes = ['individual', 'bulk', 'mylistado'];
                modes.forEach(m => {
                    const element = document.getElementById(`${m}-registration`);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                // Mostrar modo seleccionado
                const selectedElement = document.getElementById(`${mode}-registration`);
                if (selectedElement) {
                    selectedElement.style.display = 'block';
                }
                
                // Actualizar botones
                const buttons = document.querySelectorAll('.mode-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-mode') === mode) {
                        btn.classList.add('active');
                    }
                });
                
                console.log(`‚úÖ Modo de registro cambiado a: ${mode}`);
                
            } catch (error) {
                console.error('‚ùå Error cambiando modo de registro:', error);
            }
        };
        
        console.log('‚úÖ Funci√≥n switchRegistrationMode reparada');
        
    } catch (error) {
        console.error('‚ùå Error reparando switchRegistrationMode:', error);
    }
}

// Reparar sistema de notificaciones
function fixNotificationSystem() {
    console.log('üîî Reparando sistema de notificaciones...');
    
    try {
        // Crear contenedor de notificaciones si no existe
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            notificationContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 300px;
            `;
            document.body.appendChild(notificationContainer);
        }
        
        console.log('‚úÖ Sistema de notificaciones reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando sistema de notificaciones:', error);
    }
}

// Reparar sistema de sincronizaci√≥n
function fixSyncSystem() {
    console.log('üîÑ Reparando sistema de sincronizaci√≥n...');
    
    try {
        // Verificar si el sistema de votaci√≥n tiene m√©todo syncData
        if (window.votingSystem && !window.votingSystem.syncData) {
            window.votingSystem.syncData = async function() {
                console.log('üîÑ Sincronizando datos...');
                try {
                    // Implementaci√≥n b√°sica de sincronizaci√≥n
                    if (this.firebaseAvailable && this.votesCollection) {
                        const snapshot = await this.votesCollection.get();
                        this.votes = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            synced: true
                        }));
                        console.log(`‚úÖ ${this.votes.length} registros sincronizados`);
                    } else {
                        console.log('‚ö†Ô∏è Firebase no disponible para sincronizaci√≥n');
                    }
                } catch (error) {
                    console.error('‚ùå Error en sincronizaci√≥n:', error);
                }
            };
        }
        
        console.log('‚úÖ Sistema de sincronizaci√≥n reparado');
        
    } catch (error) {
        console.error('‚ùå Error reparando sistema de sincronizaci√≥n:', error);
    }
}

// Funci√≥n principal de reparaci√≥n
async function fixAllErrors() {
    console.log('üöÄ Iniciando reparaci√≥n de todos los errores...');
    
    try {
        // 1. Reparar errores de Firebase
        fixFirebaseCollectionError();
        
        // 2. Reparar errores de DOM
        fixAppendChildError();
        fixStyleError();
        
        // 3. Reparar Service Worker
        fixServiceWorkerError();
        
        // 4. Reparar funci√≥n de cambio de modo
        fixSwitchRegistrationMode();
        
        // 5. Reparar sistema de notificaciones
        fixNotificationSystem();
        
        // 6. Reparar sistema de sincronizaci√≥n
        fixSyncSystem();
        
        console.log('‚úÖ Todos los errores han sido reparados');
        
        // Verificar que las reparaciones funcionaron
        await verifyRepairs();
        
    } catch (error) {
        console.error('‚ùå Error durante la reparaci√≥n:', error);
    }
}

// Verificar que las reparaciones funcionaron
async function verifyRepairs() {
    console.log('üîç Verificando reparaciones...');
    
    const checks = [
        { name: 'Firebase Collection', check: () => window.firebaseDB && window.firebaseDB.votesCollection },
        { name: 'Switch Registration Mode', check: () => typeof window.switchRegistrationMode === 'function' },
        { name: 'Notification Container', check: () => document.getElementById('notification-container') },
        { name: 'Service Worker', check: () => 'serviceWorker' in navigator }
    ];
    
    let successCount = 0;
    
    for (const check of checks) {
        try {
            if (check.check()) {
                console.log(`‚úÖ ${check.name}: OK`);
                successCount++;
            } else {
                console.log(`‚ùå ${check.name}: Fall√≥`);
            }
        } catch (error) {
            console.log(`‚ùå ${check.name}: Error - ${error.message}`);
        }
    }
    
    console.log(`üìä Verificaci√≥n completada: ${successCount}/${checks.length} reparaciones exitosas`);
    
    return successCount === checks.length;
}

// Ejecutar reparaci√≥n autom√°ticamente
document.addEventListener('DOMContentLoaded', () => {
    console.log('üîß Ejecutando reparaci√≥n autom√°tica de errores...');
    fixAllErrors();
});

// Exportar funciones para uso manual
window.fixAllErrors = fixAllErrors;
window.fixFirebaseCollectionError = fixFirebaseCollectionError;
window.fixAppendChildError = fixAppendChildError;
window.fixStyleError = fixStyleError;
window.fixServiceWorkerError = fixServiceWorkerError;
window.fixSwitchRegistrationMode = fixSwitchRegistrationMode;
window.fixNotificationSystem = fixNotificationSystem;
window.fixSyncSystem = fixSyncSystem;

console.log('üîß Script de reparaci√≥n de errores cargado'); 